<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
    
  
  <link href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />




  
  
  
  

  

  

  

  

  

  






  

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="前端学习之路" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="前端学习之路">
<meta property="og:type" content="website">
<meta property="og:title" content="前端学习之路">
<meta property="og:url" content="https://zhulichao.github.io/page/8/index.html">
<meta property="og:site_name" content="前端学习之路">
<meta property="og:description" content="前端学习之路">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="前端学习之路">
<meta name="twitter:description" content="前端学习之路">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: undefined,
      author: '博主'
    }
  };
</script>

  <title> 前端学习之路 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?41d77ee7657d4e19a7f8a6361fe2121f";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">前端学习之路</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      

  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
  
</nav>

 </div>
      
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/me.png"
               alt="小朱" />
          <p class="site-author-name" itemprop="name">小朱</p>
          <p class="site-description motion-element" itemprop="description">前端学习之路</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">168</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">37</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">37</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/zhulichao" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.jikexueyuan.com/" title="极客学院" target="_blank">极客学院</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://caniuse.com" title="caniuse" target="_blank">caniuse</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://codepen.io" title="codepen" target="_blank">codepen</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://jsbin.com/?html,css,output" title="JS Bin" target="_blank">JS Bin</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://babeljs.io/repl/" title="Babel在线编译" target="_blank">Babel在线编译</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.iconfinder.com/iconsets/miu" title="Iconfinder图标" target="_blank">Iconfinder图标</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.bejson.com/" title="在线JSON格式化" target="_blank">在线JSON格式化</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://img.top/" title="智能图像压缩" target="_blank">智能图像压缩</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      

    </div>
  </aside>


        
    </header>
 
    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/10/29/develop-flow/" itemprop="url">
                  项目开发流程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2019-10-29T10:03:13+08:00" content="2019-10-29">
              2019-10-29
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Project-Base/" itemprop="url" rel="index">
                    <span itemprop="name">Project Base</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h2><img src="/2019/10/29/develop-flow/work-flow.jpg" title="项目开发流程">
<p>如图所示，项目的运行一共涉及6个环节。PM 在与业务方进行需求确认后产出文档，评审通过后通过 <a href="https://www.atlassian.com/software/confluence" target="_blank" rel="external">Confluence</a> 交付；UX 根据需求文档进行交互涉及，产出交互稿，评审通过后通过 <a href="https://www.abstract.com/" target="_blank" rel="external">Abstract</a> 交付，查看文件时使用 <a href="https://www.sketch.com/" target="_blank" rel="external">Sketch</a> 查看；后面 BE 和 UI 并行工作，BE 根据 UX 交互稿开发接口，没有评审，通过 Docker 镜像的形式交付，或者线上的开发环境，或者 FE 自己拉取项目启动，查看 graphql 文档；UI 根据交互稿设计页面，评审通过后通过<a href="https://lanhuapp.com/web/#/item" target="_blank" rel="external">蓝湖</a>交付，同时也会上传文件到 Abstract；BE 和 UI 都交付后，FE 进行开发，完成开发后部署到测试环境；最后由 QA 进行功能测试，使用 <a href="https://fir.im/" target="_blank" rel="external">fir.im</a> 发布移动端安装包，使用 <a href="https://www.atlassian.com/software/jira" target="_blank" rel="external">Jira</a> 进行 bug 管理 。</p>
<p>BE 和 FE 都使用 VSCode 进行开发，项目托管在 GitHub，使用 GitHub Desktop 维护代码，具体的开发流程参考<a href="/2019/11/12/git-workflow/">使用 git 开发流程</a>。</p>
<p>tip：最好从 PM 环节开始，功能模块的名称及对应的英文就已确定，后面的环节都使用统一的名称。最好所有人都参与评审，在每个环节评审前都给参与评审的人留出一些时间，提前仔细看一遍评审的内容，尽量在评审时发现并提出问题。</p>
<h2 id="评审注意点"><a href="#评审注意点" class="headerlink" title="评审注意点"></a>评审注意点</h2><h3 id="PM-—-gt-UX"><a href="#PM-—-gt-UX" class="headerlink" title="PM —&gt; UX"></a>PM —&gt; UX</h3><ul>
<li>成本：人力、时间、紧急程度</li>
<li>项目复杂度</li>
<li>能不能基于现有程序解决</li>
<li>可行的解决方案（从工程师角度出发）</li>
<li>和现有的业务是什么关系</li>
<li>对公司意味着什么</li>
</ul>
<h2 id="UX-—-gt-UI、BE"><a href="#UX-—-gt-UI、BE" class="headerlink" title="UX —&gt; UI、BE"></a>UX —&gt; UI、BE</h2><ul>
<li>功能和跳转逻辑</li>
<li>后端数据关联、数据结构、穷尽所有的状态和类型</li>
<li>状态的更新</li>
<li>各个环节提示、报错信息、placeholder</li>
<li>与以后的后台是否有冲突、更改、新增</li>
</ul>
<h2 id="BE-gt-FE"><a href="#BE-gt-FE" class="headerlink" title="BE -&gt; FE"></a>BE -&gt; FE</h2><ul>
<li>接口齐全</li>
<li>参数、返回有清晰描述</li>
<li>接口可使用</li>
<li>有测试数据</li>
</ul>
<h2 id="UI-—-gt-FE"><a href="#UI-—-gt-FE" class="headerlink" title="UI —&gt; FE"></a>UI —&gt; FE</h2><ul>
<li>文案 、素材、图片格式是否齐全</li>
<li>是否遵守规范</li>
<li>是否极端情况考虑（字最多/少）</li>
<li>适配</li>
<li>动画的开发成本</li>
<li>是否与 UX 保持一致</li>
</ul>
<h2 id="开发-—-gt-QA"><a href="#开发-—-gt-QA" class="headerlink" title="开发 —&gt; QA"></a>开发 —&gt; QA</h2><ul>
<li>准备好基础数据，如果需要准备 mock 数据</li>
<li>完成冒烟测试</li>
<li>之前测试的bug和功能是否覆盖</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/10/25/node-base/" itemprop="url">
                  Node-基础
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2019-10-25T15:14:17+08:00" content="2019-10-25">
              2019-10-25
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Node/" itemprop="url" rel="index">
                    <span itemprop="name">Node</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>__dirname 指向被执行 js 文件的绝对路径<br>./ 指向执行 node 命令的路径，一个特殊情况是在 require() 中使用 ./ 时，这时的路径就会是含有 require() 的脚本文件的相对路径<br>path.join 使用特定的分隔符将路径片段连接起来生成规范路径<br>path.resolve 把一个路径解析为绝对路径，相当于执行 cd，/ 被解析为根目录</p>
<ul>
<li><strong>Loopback — 企业级别的 node 框架</strong></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/10/16/npm-module/" itemprop="url">
                  NPM-发布包
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2019-10-16T15:55:35+08:00" content="2019-10-16">
              2019-10-16
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/NPM/" itemprop="url" rel="index">
                    <span itemprop="name">NPM</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>注册 <a href="https://www.npmjs.com/" target="_blank" rel="external">npm</a> 账号</p>
<h2 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h2><p><code>npm adduser</code> 如果报了 401 Unauthorized 错误，查看是否设置过镜像，删除 .npmrc 中的 registry 行即可</p>
<p><code>npm publish .</code></p>
<h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><p>修改 package.json 中的 version</p>
<p><code>npm publish .</code></p>
<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><p><code>npm unpublish [name] --force</code> 只有发布72小时之内的包可以删除</p>
<h2 id="使用命令"><a href="#使用命令" class="headerlink" title="使用命令"></a>使用命令</h2><p>安装包后如果想要在终端中使用命令，package.json 中需要添加 bin 字段定义命令及对应的执行文件，且该文件的第一行添加 <code>#!/usr/bin/env node</code>。</p>
<p><code>#!</code> 指明这个脚本文件的解释程序，<code>/usr/bin/env</code> 就是告诉系统可以在 PATH 目录中查找，<code>node</code> 指明用 node 执行脚本文件，所以配置 <code>#!/usr/bin/env node</code>，就是解决了不同的用户 node 路径不同的问题，可以让系统动态的去查找 node 来执行你的脚本文件。</p>
<h2 id="搭建私有仓库"><a href="#搭建私有仓库" class="headerlink" title="搭建私有仓库"></a>搭建私有仓库</h2><p><code>npm install –global verdaccio</code> 全局安装 <a href="https://github.com/verdaccio/verdaccio" target="_blank" rel="external">verdaccio</a><br><code>verdaccio</code> 启动 verdaccio<br><code>npm adduser --registry http://localhost:4873</code> 登录用户<br><code>npm set ca null</code> 如果不使用 https，设置为 null 即可<br><code>npm publish --registry http://localhost:4873</code> 发布包，不能与线上包同名<br><code>npm unpublish --registry http://localhost:4873 --force</code> 删除包</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/09/30/different-images/" itemprop="url">
                  不同类型的图片
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2019-09-30T09:26:18+08:00" content="2019-09-30">
              2019-09-30
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/CSS/" itemprop="url" rel="index">
                    <span itemprop="name">CSS</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="GIF"><a href="#GIF" class="headerlink" title="GIF"></a>GIF</h2><p>GIF（图形交换格式）1987：是位图的一种，但与JPEG或PNG不同，GIF文件最多使用来自256种颜色的色板中的颜色，虽然256种可能听起来像很多蜡笔，但复杂的照片通常有数千种色调。此颜色范围在GIF转换过程中丢失，而这也是彩色照片不使用GIF格式的关键原因。但是256色的限制可以帮助保持较小的文件大小，这对于即使是最慢的互联网速度也是理想的。无损，提供了网络透明度选项，适用于简单的动画、小图标、低像素间变化的图形（即大量的平面颜色，如标志和旗帜）。</p>
<ul>
<li>优点：动态图，可透明，体积小，可用于后台统计日志统计前端性能</li>
<li>缺点：处理256中颜色，不能半透，处理锯齿效果不好</li>
</ul>
<h2 id="JPEG"><a href="#JPEG" class="headerlink" title="JPEG"></a>JPEG</h2><p>JPEG（联合图像专家组）1992：可以将此格式称为“JPEG”或“JPG”，是一种16位格式，可以通过混合红色、蓝色和绿色光来显示数百万的颜色。这使得JPG非常“相片友好”。这就是为什么当涉及到市场上大多数的数码相机时，它会是一个标准格式的部分原因。JPEG格式还允许您灵活选择压缩图像的程度——从0％（重压缩）到100％（无压缩）。60％-75％的压缩程度会大幅缩减文件大小，同时能使您的图像在大多数屏幕看起来无差别。有损，不能保留透明度，适用于静止图像、摄影、图像具有复杂的颜色和动态。</p>
<ul>
<li>优点：色彩多</li>
<li>缺点：有损压缩</li>
</ul>
<h2 id="PNG"><a href="#PNG" class="headerlink" title="PNG"></a>PNG</h2><p>PNG（便携式网络图形）1996：就像GIF和JPEG格式之间的结合，PNG-8格式与GIF相似，使用256色板，PNG-24与JPEG相似，允许用数百万种颜色来渲染图像。无损，提供了保留透明度选项，适用于需要透明度的Web图形、颜色重和复杂的照片和图形、需要重新编辑和重新导出的图片。</p>
<ul>
<li>优点：透明、无损压缩、渐进显示和流式读写、保留图像名称、作者、版权、创作时间，可以把代码压缩到图片里去，参见开源项目 <a href="https://github.com/claus/PNGDrive" target="_blank" rel="external">PNGDrive</a></li>
<li>缺点：色彩支持少 PNG8，PNG24，PNG32，IE6 不支持</li>
</ul>
<h2 id="SVG"><a href="#SVG" class="headerlink" title="SVG"></a>SVG</h2><p>SVG（可缩放向量图形）：不是纯位图格式，是一个矢量格式。基于XML的标记，可以在任何文本编辑器中编辑，并通过JavaScript或CSS修改。因为矢量可以缩放到任何大小，同时保持清晰的图像质量，它们是响应设计的理想选择。SVG文件中嵌入位图图形是有可能的，正如在HTML中嵌入JPEG图片，这给了SVG无可挑剔的灵活性和力量。矢量/无损，适合显示在矢量图形应用程序（如Illustrator，Sketch和Inkscape）中制作的徽标，图标，地图，标记，图表和其他图形，视网膜屏幕显示。</p>
<ul>
<li>优点：矢量图，无损压缩，绘制路径 xml 语言</li>
<li>缺点：浏览器支持的不是很好，主要用于移动端 font-face</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/11/06/case-sensitive-problem/" itemprop="url">
                  大小写敏感问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-11-06T09:42:53+08:00" content="2018-11-06">
              2018-11-06
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Git/" itemprop="url" rel="index">
                    <span itemprop="name">Git</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在项目开发中，如果改变了文件或文件夹名称的大小写，默认情况下 git 是无法检测到的，因为 git 是不区分大小写的，windows 和 mac 系统默认也是不区分大小写的。</p>
<h2 id="方式一"><a href="#方式一" class="headerlink" title="方式一"></a>方式一</h2><ul>
<li><code>git config core.ignorecase false</code> 关闭 git 忽略大小写</li>
<li>修改文件名称 README.md 为 readme.md</li>
<li><code>git mv README.md readme.md</code> 在 git 中对文件重命名，如图1</li>
<li>修改文件夹名称 Folder 为 folder</li>
<li><code>git mv Folder temp &amp;&amp; git mv temp folder</code> 在 git 中对文件夹重命名，注意需使用临时名称，否则无法重命名，如图2、3</li>
<li>后面正常提交就可以了</li>
</ul>
<img src="/2018/11/06/case-sensitive-problem/mv_file.png" width="400" title="图1">
<img src="/2018/11/06/case-sensitive-problem/err.png" width="400" title="图2">
<img src="/2018/11/06/case-sensitive-problem/mv_folder.png" width="400" title="图3">
<h2 id="方式二"><a href="#方式二" class="headerlink" title="方式二"></a>方式二</h2><p>可以将电脑磁盘单独分出一个大小写敏感的分区作为开发空间，再关闭 git 忽略大小写即可。注意在大小写敏感的分区开发时，如果存在同名大小写不同的文件，有些编辑器如 vscode 可能只会加载一个文件。</p>
<p>最后，可以使用 <a href="https://github.com/Urthen/case-sensitive-paths-webpack-plugin" target="_blank" rel="external">case-sensitive-paths-webpack-plugin</a> 强制所有模块的整个路径匹配磁盘上的实际路径的。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/09/01/url-design/" itemprop="url">
                  URL 设计规范
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-09-01T13:12:13+08:00" content="2018-09-01">
              2018-09-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/URL/" itemprop="url" rel="index">
                    <span itemprop="name">URL</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>字母全部用小写，尽量短</li>
<li>使用 kebab-case（短横线分割），谷歌官方建议，有利于 SEO</li>
<li>使用 / 标识资源层级</li>
<li>在查询字符串或资源字段中使用 camelCase</li>
<li>不应包含任何用户相关的信息，避免复制 url 时绑定错误的个人信息</li>
<li>避免太多参数，目录层次尽量少</li>
<li>总是使用复数名词来命名指向一个集合的 url：/users</li>
<li>在源代码中，将复数转换为具有列表后缀名描述的变量和属性</li>
<li>坚持这样一个概念：始终以集合名起始并以标识符结束，如 /students/123</li>
<li>URLs 里面请尽量少用动词</li>
<li>为非资源型请求使用动词，这种情况下，API 并不需要返回任何资源，而是去执行一个操作并返回执行结果，这些不是 CRUD 操作</li>
<li>请求体或响应类型如果是 JSON，那么请遵循 camelCase 规范为 JSON 属性命名来保持一致性</li>
<li>即使资源类似于对象实例或数据库记录的单一概念，也不应该将 table_name 用作资源名称或将 column_name 作为资源属性</li>
<li>只有在您的 URL 上面命名资源时才使用名词，不要尝试解释其功能</li>
<li>对于嵌套资源，请在 URL 中把他们的关系表现出来，如 /schools/2/students/31，表示得到 2 学校的 31 学生的信息</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/08/25/wechat-service-base/" itemprop="url">
                  微信服务号开发基础
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-08-25T13:49:07+08:00" content="2018-08-25">
              2018-08-25
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/WeChat/" itemprop="url" rel="index">
                    <span itemprop="name">WeChat</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>微信服务号开发其实就是普通的网站开发，只不过其中可调用微信的 js-sdk 使用基于微信的 api，我们的项目中只是使用了支付、隐藏/显示菜单、自定义分享内容的功能，主要是为了支持小程序不能进行 iOS 支付的问题。由于一部分功能是在小程序中的，就需要小程序与服务号的互相跳转。服务号可通过菜单的定义、长按图片识别二维码跳转到小程序，由于小程序内部只能识别小程序码，不能直接跳转到服务号，只能使用图片+文字引导的方式让用户自己进入服务号。</p>
<h2 id="在线工具"><a href="#在线工具" class="headerlink" title="在线工具"></a>在线工具</h2><p><a href="https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login" target="_blank" rel="external">公众平台测试账号</a><br><a href="https://mp.weixin.qq.com/debug" target="_blank" rel="external">微信公众平台接口调试工具</a><br><a href="https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=jsapisign" target="_blank" rel="external">微信 JS 接口签名校验工具</a></p>
<h2 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h2><ul>
<li>扫码登录<a href="https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login" target="_blank" rel="external">公众平台测试账号</a>。</li>
<li>接口配置信息，URL 为后端地址，如“<a href="http://lichao-server.example/api/weixin”" target="_blank" rel="external">http://lichao-server.example/api/weixin”</a></li>
<li>JS接口安全域名，前端域名，如“lichao.example”</li>
<li>体验接口权限表中，网页服务/网页账号，修改网页授权获取用户基本信息为后端域名，如“lichao-server.example”</li>
<li>后端需要 appID、appsecret、Token 进行微信授权、微信支付等操作</li>
<li>如果是前后端分离的，后端需要设置跨域</li>
<li><p>如果是前后端分离的，后端需要设置 cookie 在指定域名下的共享</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> * <span class="keyword">as</span> cors <span class="keyword">from</span> <span class="string">'cors'</span>;</div><div class="line">...</div><div class="line"><span class="comment">// 跨域设置，origin 为前端地址</span></div><div class="line">app.use(</div><div class="line">  cors(&#123;</div><div class="line">    origin(origin, cb) &#123;</div><div class="line">      cb(<span class="literal">undefined</span>, server.whitelist.includes(origin));</div><div class="line">    &#125;,</div><div class="line">    credentials: <span class="literal">true</span>,</div><div class="line">  &#125;),</div><div class="line">);</div><div class="line"><span class="comment">// 共享 cookie 设置，server.domain 为前后端都可使用的域名</span></div><div class="line">app.use(</div><div class="line">  session(&#123;</div><div class="line">    store: <span class="keyword">new</span> (connectRedis(session))(&#123; client: redis &#125;),</div><div class="line">    name: <span class="string">'sid'</span>,</div><div class="line">    resave: <span class="literal">true</span>,</div><div class="line">    saveUninitialized: <span class="literal">true</span>,</div><div class="line">    secret: server.sessionSecret,</div><div class="line">    cookie: &#123; maxAge: <span class="number">30</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>, domain: server.domain &#125;,</div><div class="line">  &#125;),</div><div class="line">);</div></pre></td></tr></table></figure>
</li>
<li><p>前端需要 appID 执行 wx.config 进行 js-sdk 签名</p>
</li>
</ul>
<h2 id="真机调试"><a href="#真机调试" class="headerlink" title="真机调试"></a>真机调试</h2><p>使用手机微信打开网页就是线上运行的效果，但这样不能使用 localhost 或 127.0.0.1 的地址，需要内网穿透工具进行本地端口映射，然后通过穿透的地址访问，可以使用 <a href="https://ngrok.com/" target="_blank" rel="external">ngrok</a>，但是有些慢，还是建议团队搭建完善的开发环境。</p>
<p>可使用<a href="https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html" target="_blank" rel="external">微信开发者工具</a>或<a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1455784140" target="_blank" rel="external">微信web开发者工具</a>进行调试。打开微信web开发者工具可能会报错，一直点确定就打开了。微信web开发者工具可进行移动调试，但需要注意，它在 Network 中显示的请求可能不准确，个人认为是过滤掉了微信内部的请求。以下为授权操作的请求对比。</p>
<img src="/2018/08/25/wechat-service-base/error.png" width="400" title="微信web开发者工具报错">
<img src="/2018/08/25/wechat-service-base/tool.png" title="微信开发者工具">
<img src="/2018/08/25/wechat-service-base/web_tool.png" title="微信web开发者工具">
<h2 id="登录授权"><a href="#登录授权" class="headerlink" title="登录授权"></a>登录授权</h2><p>参考<a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421140842" target="_blank" rel="external">微信网页授权</a>文档，工作主要是在后端，提供一个地址供前端访问，其余工作都由后端完成。后端确保 appID、appsecret、Token 值正确，服务号设置确保接口配置信息、JS接口安全域名、授权回调页面域名正确，即可完成登录授权。前后端都需要注意哪些设置的值是带协议的，哪些是不带协议的，如果服务号设置和后端设置的 appID 等值是正确的，可能是由于多带或少带协议名返回 redirect_uri 错误。我们项目中的 API_SERVER_URL 环境变量如果带了协议名，就会返回这个错误。在微信开发者工具中，授权是跳转到一个登录的页面，在真机上是弹框授权。</p>
<p>因为微信网页授权其实是进行的页面跳转，在项目中如果授权后仍然停留在当前页面，但要发生一些行为，如弹框，只能通过授权后的回调地址带参数的形式。<strong>建议授权后的回调地址如果需要传参数，使用 hash 的形式传参</strong>，这是因为这个页面如果需要使用 js-sdk，在 iOS 上页面路径发生变化可能会导致 <code>wx.config()</code> 执行失败，但 hash 的形式不会有影响。进入页面时在 componentDidMount 中判断 url 是否带有指定的 hash 参数，有则表示是授权后进入的当前页面，执行指定的行为，然后将页面 hash 参数置空。正常情况下授权后进入页面会重新加载整个页面，也就是会执行完整的生命周期方法进入 componentDidMount 中，<strong>但实际中发现有些情况并没有进入 componentDidMount 方法</strong>，因此在 componentDidMount 方法中添加了 hashchange 的监听，在 componentWillUnmount 中取消监听，如果在 componentDidMount 方法中需要网络请求的，也需要注意在授权返回后是否真正发起了该请求以及请求是走的网络还是缓存，可能需要进行特殊处理，就完整的解决了微信网页授权问题。</p>
<p>微信开发者工具中可通过，清缓存 -&gt; 清除开发者工具cookie 取消授权；iOS 真机可通过微信中，我 -&gt; 设置 -&gt; 通用 -&gt; 存储空间 -&gt; 清理微信缓存，取消授权；anroid 真机可通过在微信中，打开网页 debugx5.qq.com，勾上最下面的四项 Cookie、文件缓存、广告过滤缓存、DNS缓存，点击清除取消授权。</p>
<p>示例代码如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> queryString <span class="keyword">from</span> <span class="string">'query-string'</span>;</div><div class="line">...</div><div class="line">class Page extends React.Component &#123;</div><div class="line">  public <span class="keyword">async</span> componentDidMount() &#123;</div><div class="line">    <span class="comment">// 判断是否是后端登录返回的</span></div><div class="line">    <span class="keyword">this</span>.replaceUrl();</div><div class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">'hashchange'</span>, <span class="keyword">this</span>.replaceUrl);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  public componentWillUnmount() &#123;</div><div class="line">    <span class="built_in">window</span>.removeEventListener(<span class="string">'hashchange'</span>, <span class="keyword">this</span>.replaceUrl);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  public replaceUrl = () =&gt; &#123;</div><div class="line">    <span class="keyword">if</span> (<span class="built_in">window</span>) &#123;</div><div class="line">      <span class="keyword">const</span> parsedHash = queryString.parse(<span class="built_in">window</span>.location.hash);</div><div class="line">      <span class="keyword">if</span> (parsedHash.show === <span class="string">'true'</span>) &#123;</div><div class="line">        <span class="built_in">window</span>.location.hash = <span class="string">''</span>;</div><div class="line">        <span class="comment">// 显示 actionSheet</span></div><div class="line">        <span class="keyword">this</span>.actionSheet.handleShow();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  public showActionSheet = <span class="keyword">async</span> () =&gt; &#123;</div><div class="line">    <span class="keyword">const</span> callbackUri = <span class="string">`<span class="subst">$&#123;config.clientUrl&#125;</span>/sharePlan#show=true`</span>;</div><div class="line">    Router.push(</div><div class="line">      <span class="string">`<span class="subst">$&#123;config.serverUrl&#125;</span>/api/weixin/auth?callbackUri=<span class="subst">$&#123;callbackUri&#125;</span>`</span>,</div><div class="line">    );</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  public render() &#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="js-sdk-使用"><a href="#js-sdk-使用" class="headerlink" title="js-sdk 使用"></a>js-sdk 使用</h2><p>参考<a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421141115" target="_blank" rel="external">微信JS-SDK说明文档</a>文档，前端所有需要使用 JS-SDK 的页面必须先执行 <code>wx.config()</code> 注入配置信息，前端传入页面 url 给后端，后端返回 timestamp、nonceStr、signature，建议 appId 也一起由后端返回，前端就不需要自己配置 appID 了。</p>
<p>从文档中看注入配置信息没有什么难点，在微信开发者工具、android 真机也非常顺利，但 iOS 真机处了问题，一直提示“invalid signature签名错误”，各种排查问题，后来通过复制页面连接，<strong>发现在 iOS 真机单页应用在路由切换时页面 url 一直保持不变，都是第一个打开页面的 url，这是单页应用的问题</strong>。因此使用了，在项目入口文件，定义一个变量保存页面 url，该变量只被赋值一次，来确保该变量保存的是初次进入页面的 url，然后通过 context 的形式传入到其它页面，在获取 wx.config 的签名参数时，判断如果是 iOS 平台，则传入 context 中的第一个打开页面的 url，否则传入当前页面 url，就解决了签名错误的问题。</p>
<p>还有一个可能遇到的问题，通过服务号进入页面时报签名错误，复制当前网页链接直接进入则签名正确，请检查服务号菜单配置中路径是否正确，可能是路径末尾缺少一个 <code>/</code>。程序猿已在风中凌乱。。。</p>
<p>示例代码如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// _app.tsx</span></div><div class="line"><span class="keyword">const</span> ContextType = &#123;</div><div class="line">  initialUrl: PropTypes.string,</div><div class="line">&#125;;</div><div class="line"><span class="keyword">let</span> initialUrl;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">App</span> </span>&#123;</div><div class="line">  public <span class="keyword">static</span> childContextTypes = ContextType;</div><div class="line"></div><div class="line">  public <span class="keyword">static</span> <span class="keyword">async</span> getInitialProps(&#123; Component, ctx &#125;) &#123;</div><div class="line">    <span class="keyword">let</span> pageProps = &#123;&#125;;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (Component.getInitialProps) &#123;</div><div class="line">      pageProps = <span class="keyword">await</span> Component.getInitialProps(ctx);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> &#123; pageProps, query: ctx.query, asPath: ctx.asPath &#125;;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  public getChildContext() &#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">      initialUrl,</div><div class="line">    &#125;;</div><div class="line">  &#125;</div><div class="line">  ...</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 使用组件</span></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">  <span class="comment">// 1.获取签名需要的页面 url</span></div><div class="line">  <span class="keyword">let</span> signUrl = <span class="string">`<span class="subst">$&#123;config.clientUrl&#125;</span><span class="subst">$&#123;Router.asPath&#125;</span>`</span>;</div><div class="line">  <span class="comment">// 1.1判断 ios 终端</span></div><div class="line">  <span class="keyword">const</span> userAgent = navigator.userAgent;</div><div class="line">  <span class="keyword">const</span> isiOS = !!userAgent.match(<span class="regexp">/\(i[^;]+;( U;)? CPU.+Mac OS X/</span>);</div><div class="line">  <span class="keyword">if</span> (isiOS) &#123;</div><div class="line">    signUrl = <span class="string">`<span class="subst">$&#123;config.clientUrl&#125;</span><span class="subst">$&#123;this.context.initialUrl&#125;</span>`</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 2.调用后台接口获取签名需要的参数</span></div><div class="line">  <span class="keyword">const</span> signSdkData: SignSdkData = <span class="keyword">await</span> <span class="keyword">this</span>.context.client.query(&#123;</div><div class="line">    fetchPolicy: <span class="string">'network-only'</span>,</div><div class="line">    query: signSdkQuery,</div><div class="line">    variables: &#123;</div><div class="line">      uri: signUrl,</div><div class="line">    &#125;,</div><div class="line">  &#125;);</div><div class="line">  <span class="comment">// 3.进行 js-sdk 签名</span></div><div class="line">  <span class="keyword">if</span> (signSdkData &amp;&amp; signSdkData.data &amp;&amp; signSdkData.data.signSdk) &#123;</div><div class="line">    <span class="keyword">const</span> &#123; appId, nonceStr, signature, timestamp &#125; = signSdkData.data.signSdk;</div><div class="line">    wx.config(&#123;</div><div class="line">      appId,</div><div class="line">      debug: <span class="literal">true</span>,</div><div class="line">      jsApiList: [</div><div class="line">        <span class="string">'onMenuShareAppMessage'</span>,</div><div class="line">        <span class="string">'onMenuShareTimeline'</span>,</div><div class="line">        <span class="string">'hideMenuItems'</span>,</div><div class="line">        <span class="string">'showMenuItems'</span>,</div><div class="line">      ],</div><div class="line">      nonceStr,</div><div class="line">      signature,</div><div class="line">      timestamp,</div><div class="line">    &#125;);</div><div class="line">    <span class="comment">// 4.签名成功执行回调</span></div><div class="line">    wx.ready(() =&gt; &#123;</div><div class="line">      <span class="keyword">this</span>.props.callback();</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125; <span class="keyword">catch</span> (error) &#123;</div><div class="line">  <span class="built_in">console</span>.log(error);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="生产环境"><a href="#生产环境" class="headerlink" title="生产环境"></a>生产环境</h2><ul>
<li>注册服务号，进行微信认证</li>
<li>开发者工具 -&gt; web开发者工具， 添加开发者账号，才可开发该 appID 的服务号</li>
<li>设置 -&gt; 人员设置，添加运行人员，可登录后台和群发消息</li>
<li>功能 -&gt; 自定义菜单，配置菜单</li>
<li>小程序 -&gt; 小程序管理，添加关联的小程序</li>
<li>小程序 -&gt; 展示场景，在公众号资料中展示小程序</li>
<li>设置 -&gt; 公众号设置 -&gt; 功能设置，JS接口安全域名为前端域名，网页授权域名为后端域名，业务域名暂时没用</li>
<li>开发 -&gt; 基本配置，IP白名单中添加后端 IP，服务器配置未启用</li>
<li>微信商户平台 -&gt; 产品中心 -&gt; 开发配置，设置H5支付的授权目录，注意是目录，以<code>/</code>结尾，如 <code>http://example.com/pages/</code></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/08/25/wechat-data-analytics/" itemprop="url">
                  小程序数据分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-08-25T13:45:13+08:00" content="2018-08-25">
              2018-08-25
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/WeChat/" itemprop="url" rel="index">
                    <span itemprop="name">WeChat</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>由于微信自己的机制，无论是用微信公众平台，还是用第三方的数据分析平台，都有可能存在数据不准确的情况。我们的小程序由于能够统计每天的收入情况，对比发现过微信公众平台和诸葛io都存在购买数据的偏差。</p>
<h2 id="基于微信公众平台"><a href="#基于微信公众平台" class="headerlink" title="基于微信公众平台"></a>基于<a href="https://mp.weixin.qq.com" target="_blank" rel="external">微信公众平台</a></h2><p>微信公众平台中，也就是小程序管理后台，本身提供了基础的数据分析的功能，无需上报数据也能分析一部分数据。也可通过小程序开发文档中提供的自定义数据上报接口 <code>wx.reportAnalytics</code> 在代码中上报需要的数据，使用前，需要在小程序管理后台自定义分析中新建事件，配置好事件名与字段。使用小程序管理后台很简单，不用做用户标识，因为微信自己是能通过 openId 区分用户的，无需自己处理，也不用上报场景值和用户画像等基本信息。缺点是，小程序管理后台：</p>
<ul>
<li>不能自定义面板</li>
<li>对自定义分析的查询日期跨度不能超过31天</li>
<li>不能添加自定义的用户属性，不能创建用户分群</li>
<li>不能查看原始数据，更不能下载了</li>
<li>没有渠道分析，当然这个可以自己做</li>
</ul>
<h2 id="基于诸葛io"><a href="#基于诸葛io" class="headerlink" title="基于诸葛io"></a>基于<a href="https://zhugeio.com/" target="_blank" rel="external">诸葛io</a></h2><p>为了解决小程序管理后台数据分析存在的问题，我们对比了很多支持小程序的数据分析产品，列表如下，最后选择了诸葛io。</p>
<ul>
<li><a href="http://mta.qq.com/mta/ctr_index/opd" target="_blank" rel="external">腾讯移动分析</a></li>
<li><a href="https://www.aldwx.com/" target="_blank" rel="external">阿拉丁小程序统计平台</a></li>
<li><a href="https://www.sensorsdata.cn/manual/mp_sdk.html" target="_blank" rel="external">神策数据</a></li>
<li><a href="https://www.talkingdata.com/" target="_blank" rel="external">TalkingData</a></li>
<li><a href="https://jice.io/" target="_blank" rel="external">及策</a></li>
<li><a href="https://ark.analysys.cn/" target="_blank" rel="external">易观方舟</a></li>
<li><a href="https://www.growingio.com/" target="_blank" rel="external">GrowingIO</a></li>
<li><a href="https://zhugeio.com/" target="_blank" rel="external">诸葛io</a></li>
</ul>
<p>总体来说，诸葛io解决了上述小程序后台存在的所有问题，而且提供了下载原始数据的方式，集成简单，调试也快，后台也可以添加多个用户并授予不同权限。后台创建用户分群、创建面板方式比较简单，不需要工程师去创建，业务人员可以自己创建。缺点就是付费😂，上面也说过了，数据会有些偏差，但是很有可能没办法避免。</p>
<h2 id="基于Google-Analytics"><a href="#基于Google-Analytics" class="headerlink" title="基于Google Analytics"></a>基于<a href="https://analytics.google.com/" target="_blank" rel="external">Google Analytics</a></h2><p>小程序中集成 <a href="https://github.com/rchunping/wxapp-google-analytics" target="_blank" rel="external">wxapp-google-analytics</a> 后，<strong>按照文档进行操作</strong>，可上报数据到 Google Analytics，经试验以下功能都可正常使用：</p>
<ul>
<li>可上报页面访问，支持自定义维度和指标</li>
<li>可上报事件，若要上报自定义维度和指标，需修改 ga.js 文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">EventBuilder.prototype.build = function() &#123;</div><div class="line">  // 去除无效字段字段</div><div class="line">  hit_delete_if(this, &apos;ev&apos;, 0);</div><div class="line">  hit_delete_if(this, &apos;el&apos;, &apos;&apos;);</div><div class="line"></div><div class="line">  // 添加--处理自定义维度和指标</div><div class="line">  var cd_arr = this.custom_dimensions;</div><div class="line">  var cm_arr = this.custom_metrics;</div><div class="line">  var i;</div><div class="line"></div><div class="line">  for (i = 0; i &lt; cd_arr.length; i++) &#123;</div><div class="line">    var cd = cd_arr[i];</div><div class="line">    this.hit[&apos;cd&apos; + cd[0]] = cd[1];</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  for (i = 0; i &lt; cm_arr.length; i++) &#123;</div><div class="line">    var cm = cm_arr[i];</div><div class="line">    this.hit[&apos;cm&apos; + cm[0]] = cm[1];</div><div class="line">  &#125;</div><div class="line">  // 添加--结束</div><div class="line"></div><div class="line">  return HitBuilder.prototype.build.apply(this, arguments);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<ul>
<li>渠道分析</li>
<li>跟踪场景值</li>
<li>跟踪二维码参数</li>
<li>可标识用户，清除 storage/_ga_cid 后，将产生一个新用户，这也意味着用户删除小程序后再次进入将作为一个新用户</li>
</ul>
<p>Google Analytics 中受众群体下的报告反映都很慢，想看到用户数据上报情况很可能第二天才能看到，有时第二天也没看到数据，还需要重新测，很担心线上环境也会出现这种情况。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/08/25/wechat-review/" itemprop="url">
                  小程序审核相关
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-08-25T13:03:18+08:00" content="2018-08-25">
              2018-08-25
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/WeChat/" itemprop="url" rel="index">
                    <span itemprop="name">WeChat</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="小程序如何提审"><a href="#小程序如何提审" class="headerlink" title="小程序如何提审"></a>小程序如何提审</h2><p>小程序中只要修改了代码，上线就需要审核，如果通过修改 url 的形式来决定是访问测试服务器还是线上服务器，就需要进行2次审核，而且需要后端先上线。解决这个问题，可以前端和后端都维护一个版本号，前端可以使用动态拼接 url 的方式访问后端接口，如 /api1/xxx，/api2/xxx，或者在请求参数里带上版本号，后端收到请求时拿到的版本号，与自己保存的版本号做对比决定是访问测试服务器还是线上服务器。</p>
<h2 id="小程序审核被拒情形"><a href="#小程序审核被拒情形" class="headerlink" title="小程序审核被拒情形"></a>小程序审核被拒情形</h2><ul>
<li>购买在线课程会被指定为虚拟支付</li>
<li>打卡返现会被指定为赌博活动</li>
<li>电子课程含“未解锁”课程，并引导至公众号解锁课程会被指定为内容不符合规则</li>
<li>没有课程的用户如果直接显示暂无课程，会被指定为可用性和完整性不符合规则</li>
<li>微信测试人员账号可能会出现奇怪的问题，可能会没有 unionId，导致使用小程序里面的功能出现问题</li>
</ul>
<p>注意：提交审核如果被拒了，经过排查发现是微信自己的问题，可在社区中发帖子描述问题，可能会过审。在小程序后台提交审核没有填写描述的地方，但是使用微信开发者工具上传代码时可以添加项目备注，到小程序后台会出现在描述字段，这里的信息审核人员是会看的。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/08/25/wechat-problem/" itemprop="url">
                  小程序开发遇到问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-08-25T13:03:13+08:00" content="2018-08-25">
              2018-08-25
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/WeChat/" itemprop="url" rel="index">
                    <span itemprop="name">WeChat</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>以下记录的为开发过程中遇到的零散问题及解决方案。</p>
<h2 id="登录流程"><a href="#登录流程" class="headerlink" title="登录流程"></a>登录流程</h2><img src="/2018/08/25/wechat-problem/flow.png" title="小程序登录流程">
<h2 id="部分用户没有-unionId"><a href="#部分用户没有-unionId" class="headerlink" title="部分用户没有 unionId"></a>部分用户没有 unionId</h2><p>如上面登录逻辑梳理所述，进入小程序时，如果判断当前进行了用户授权，会使用 wx.getUserInfo 获取用户加密信息 encryptedData 和 iv 以及 wx.login 返回的 code 调用后台接口，后台处理会调用微信接口，通常微信接口会返回用户的 unionId，但发现有的用户就没有返回 unionId。在社区搜了一下这个问题，发现可能会存在微信接口没有返回 unionId 的情况，但通过解密 encryptedData 一定能拿到 unionId，因此改变了获取 unionId 的方式就解决了这个问题。</p>
<h2 id="登录加载慢"><a href="#登录加载慢" class="headerlink" title="登录加载慢"></a>登录加载慢</h2><p>小程序线上环境，有部分用户会登录加载很慢，但是我自己没有复现过这个现象，也没办法排查问题。后来发现本地使用<strong> ngrok 进行内网穿透</strong> 调试时，有时就会出现这个登录加载慢的问题，经过排查发现，前端在进入小程序时，先使用 wx.login 获取 code，然后调用后台 getInfo 接口拿到用户 openId 进行数据上报，同时也调用后台 login 接口进行用户登录，这两个后台接口都调用了 <a href="https://api.weixin.qq.com/sns/jscode2session" target="_blank" rel="external">https://api.weixin.qq.com/sns/jscode2session</a> 接口获取 session_key。后台本身是做了通过将 code 值存入数据库来防止重复使用 code 的兼容的，但是可能会存在同时进入后台的这两个请求，还没有完成存入数据库的操作，后台报了 code 被重复使用的错误没有继续向下执行，因此前端一直处于等待状态，导致登录加载卡死在等待中。</p>
<h2 id="iOS-上头像不显示"><a href="#iOS-上头像不显示" class="headerlink" title="iOS 上头像不显示"></a>iOS 上头像不显示</h2><p>问题：在【我的】页面，进入时查询用户信息，如果没有用户信息，显示默认头像图片，如果有用户信息，显示指定 url 的用户头像，但在 iOS 上返回用户信息后仍然显示默认图像，image 组件的 src 属性是正确的头像链接。</p>
<p>解决：在 iOS 上 image 组件在 src 变化后不一定能显示更新后的图片，使用两个 image 组件，根据有没有 url 值决定显示默认头像还是用户头像，就没有问题了。</p>
<h2 id="重复进入页面"><a href="#重复进入页面" class="headerlink" title="重复进入页面"></a>重复进入页面</h2><p>问题：在网络条件不好时可能存在点击按钮跳转页面，可能会多次跳转同一个页面，也要点击多次返回才能返回到正确的页面。</p>
<p>解决：在跳转前判断要进入的页面是否在路由栈已经存在。示例代码如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Page(&#123;</div><div class="line">    ...</div><div class="line">    navigateToPage() &#123;</div><div class="line">        <span class="keyword">const</span> pages = getCurrentPages();</div><div class="line">        <span class="keyword">if</span> (pages[pages.length - <span class="number">1</span>].route === <span class="string">'pages/xxx/xxx'</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        wx.navigateTo(&#123;</div><div class="line">            url: <span class="string">'/pages/xxx/xxx'</span>,</div><div class="line">        &#125;);</div><div class="line">    &#125;,</div><div class="line">    ...</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="网络图片存在缓存"><a href="#网络图片存在缓存" class="headerlink" title="网络图片存在缓存"></a>网络图片存在缓存</h2><p>小程序中使用的网络图片，如果 url 没有发生变化，但后台更新了图片，使用小程序时可能会存在图片没有更新过来，把小程序从记录中删除了再打开，就可以了。也可以在使用图片的 url 后面添加查询参数 <code>url + &#39;?&#39; + Dare.parse(new Date())</code> 的方式不让小程序缓存图片。web-view 中打卡的网页链接也可以这么处理。</p>
<h2 id="一个值得思考的-bug"><a href="#一个值得思考的-bug" class="headerlink" title="一个值得思考的 bug"></a>一个值得思考的 bug</h2><p>问题描述：A 页面 -&gt; B 页面 -&gt; C 页面，在 C 页面中，进行背景音频播放，并添加了背景音频播放的监听，onPlay、onPause、onTimeUpdate、onEnded、onStop，这些监听中主要是更新当前页面的 data 值，来控制页面中的显示，如显示播放/暂停按钮，显示当前播放进度等，<strong>并更新全局的当前播放音频的信息</strong>，在从 C 页面返回到 B 页面及 A 页面时，会显示一个悬浮播放的控件，显示正在播放的背景音频的信息及播放进度。问题是在从 C 页面返回后，如果是从背景音频点击的暂停，悬浮播放控件中显示的当前播放进度会显示从 C 页面返回时的进度，而不是当前播放进度。</p>
<p>分析原因：经过大概1小时的 bug 追踪，发现问题的原因是背景音频播放的监听是在 C 页面内的，在 onPause 监听中，更新全局播放音频信息的代码是如下代码中的第一段，但从 C 页面返回后，C 页面已经销毁了，这时再获取 this.data.tipRecord 是销毁页面前的数据（刚开始这么写的时候我以为会报错），也就是从 C 返回时的数据。将代码修改为第二段，主要是更新全局提示记录的处理是基于全局 store 中的数据，而不是当前页面的 data，该问题就解决了。</p>
<p>在 C 页面中的音频播放监听方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">// 第一段，有问题的</div><div class="line">this.backgroundAudioManager.onPause(() =&gt; &#123;</div><div class="line">    // 全局提示记录处理，更新 store 中的全局信息</div><div class="line">    this.setTipRecord(&#123;</div><div class="line">        ...this.data.tipRecord,</div><div class="line">        show: true,</div><div class="line">        paused: true,</div><div class="line">    &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">// 第二段，修正后的</div><div class="line">this.backgroundAudioManager.onPause(() =&gt; &#123;</div><div class="line">    // 获取全局 store 中的音频播放信息</div><div class="line">    const storeData = this.store.getState();</div><div class="line">    // 全局提示记录处理，更新 store 中的全局信息</div><div class="line">    this.setTipRecord(&#123;</div><div class="line">        ...storeData.tipRecord,</div><div class="line">        show: true,</div><div class="line">        paused: true,</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="微信用户可能没有头像"><a href="#微信用户可能没有头像" class="headerlink" title="微信用户可能没有头像"></a>微信用户可能没有头像</h2><p>在开发打卡生成图片的功能时，很多都需要使用用户的头像，注意会存在没有头像的微信用户，需要处理该种情况。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" href="/page/9/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
       
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">小朱</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery.lazyload/1.9.3/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  



  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;

            $('.popup').detach().appendTo('.container');
            //$('.popup').detach().appendTo('.header-inner');

            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';                
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });
                            
                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').mousedown(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>

  

  

  

</body>
</html>
