<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
    
  
  <link href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />




  
  
  
  

  

  

  

  

  

  






  

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="前端学习之路" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="前端学习之路">
<meta property="og:type" content="website">
<meta property="og:title" content="前端学习之路">
<meta property="og:url" content="https://zhulichao.github.io/page/4/index.html">
<meta property="og:site_name" content="前端学习之路">
<meta property="og:description" content="前端学习之路">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="前端学习之路">
<meta name="twitter:description" content="前端学习之路">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: undefined,
      author: '博主'
    }
  };
</script>

  <title> 前端学习之路 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?41d77ee7657d4e19a7f8a6361fe2121f";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">前端学习之路</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      

  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
  
</nav>

 </div>
      
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/me.png"
               alt="小朱" />
          <p class="site-author-name" itemprop="name">小朱</p>
          <p class="site-description motion-element" itemprop="description">前端学习之路</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">168</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">37</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">37</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/zhulichao" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.jikexueyuan.com/" title="极客学院" target="_blank">极客学院</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://caniuse.com" title="caniuse" target="_blank">caniuse</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://codepen.io" title="codepen" target="_blank">codepen</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://jsbin.com/?html,css,output" title="JS Bin" target="_blank">JS Bin</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://babeljs.io/repl/" title="Babel在线编译" target="_blank">Babel在线编译</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.iconfinder.com/iconsets/miu" title="Iconfinder图标" target="_blank">Iconfinder图标</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.bejson.com/" title="在线JSON格式化" target="_blank">在线JSON格式化</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://img.top/" title="智能图像压缩" target="_blank">智能图像压缩</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      

    </div>
  </aside>


        
    </header>
 
    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/07/22/javascript-memory-allocation/" itemprop="url">
                  JavaScript-内存分配
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2020-07-22T10:28:58+08:00" content="2020-07-22">
              2020-07-22
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index">
                    <span itemprop="name">JavaScript</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>原始数据类型值，比如Undefined,Null,Boolean,Number,String，是存储在栈（stack）中的简单数据段，也就是说，它们的值直接存储在变量访问的位置。这是因为这些原始类型占据的空间是固定的，所以可将他们存储在较小的内存区域 – 栈中。这样存储便于迅速查寻变量的值。</p>
<p>引用类型值，也就是对象类型 Object type,比如Object,Array,Function,Date等，是存储在堆（heap）中的对象，也就是说，存储在变量处的值是一个指针（point），指向存储对象的内存地址。这是因为：引用值的大小会改变，所以不能把它放在栈中，否则会降低变量查寻的速度。相反，放在变量的栈空间中的值是该对象存储在堆中的地址，地址的大小是固定的，所以把它存储在栈中对变量性能无任何负面影响。</p>
<p>在javascript中是不允许直接访问保存在堆内存中的对象的，所以在访问一个对象时，首先得到的是这个对象在堆内存中的地址，然后再按照这个地址去获得这个对象中的值，这就是传说中的按引用访问。而原始类型的值则是可以直接访问到的。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/07/22/javascript-garbage-collection/" itemprop="url">
                  JavaScript-垃圾回收
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2020-07-22T09:50:02+08:00" content="2020-07-22">
              2020-07-22
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index">
                    <span itemprop="name">JavaScript</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="垃圾回收机制"><a href="#垃圾回收机制" class="headerlink" title="垃圾回收机制"></a>垃圾回收机制</h2><p>如果一个对象不再被引用， 那么这个对象就会被垃圾回收机制回收；如果两个对象互相引用， 且不再被第3者所引用， 那么这两个互相引用的对象也会被回收。在闭包中，父函数被子函数引用，子函数又被外部的一个变量引用，这就是父函数不被回收的原因。</p>
<p>如果不再用到的内存，没有及时释放，我们就称之为内存泄漏。大多数语言都有它自身的垃圾回收机制，这样的好处是自动帮我们清理不必要的内存占用，但是我们的可控性却比较差，而C语言就无法自动清理垃圾，但它的可控性较强。</p>
<p>在 Javascript 中，垃圾回收机制会定期（周期性）找出那些不再用到的内存（变量），然后释放其内存，以此来解决内存泄漏的问题。但并不是说有了垃圾回收机制，程序员就轻松了。你还是需要关注内存占用：那些很占空间的值，一旦不再用到，你必须检查是否还存在对它们的引用，如果没有引用就必须手动解除引用。 现在各大浏览器通常采用的垃圾回收机制有两种方法：标记清除，引用计数。js中最常用的垃圾回收方式就是标记清除。</p>
<h3 id="标记清除"><a href="#标记清除" class="headerlink" title="标记清除"></a>标记清除</h3><p>首先给所有的变量或者对象添加一个标记，当变量进入环境（引用变量）的时候，把上一步标记的内容清除，当变量离开环境（不再需要引用变量）的时候，再重新给这些变量添加标记，这些重新添加上标记的变量或对象会回收到垃圾回收机器里面，垃圾回收机制会周期性的清除这些垃圾回收机器里面的所有对象或属性。</p>
<h3 id="引用计数"><a href="#引用计数" class="headerlink" title="引用计数"></a>引用计数</h3><p>语言引擎有一张”引用表”，保存了内存里面所有资源（通常是各种值）的引用次数。如果一个值的引用次数是0，就表示这个值不再用到了，因此可以将这块内存释放。但是引用计数有个最大的问题循环引用，最好是在不使用它们的时候手动将它们设为空。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">let</span> obj1 = &#123;&#125;;</div><div class="line">    <span class="keyword">let</span> obj2 = &#123;&#125;;</div><div class="line"></div><div class="line">    obj1.a = obj2; <span class="comment">// obj1 引用 obj2</span></div><div class="line">    obj2.a = obj1; <span class="comment">// obj2 引用 obj1</span></div><div class="line"></div><div class="line">    <span class="comment">// 手动清除</span></div><div class="line">    obj1 = <span class="literal">null</span>;</div><div class="line">    obj2 = <span class="literal">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="闭包的垃圾回收"><a href="#闭包的垃圾回收" class="headerlink" title="闭包的垃圾回收"></a>闭包的垃圾回收</h2><p>由于闭包时建立在一个函数内部的子函数，由于其可访问上级作用域的原因，即使上级函数执行完，作用域也不会随之销毁，这时的子函数—也就是闭包，便拥有了访问上级作用域中的变量的权限，即使上级函数执行完后，作用域内的值也不会被销毁，这个函数的作用域就会一直保存到闭包不存在为止。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">fn3</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> a = <span class="number">10</span>;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        a--;</div><div class="line">        <span class="built_in">console</span>.log(a);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">fn3()(); <span class="comment">// 9</span></div><div class="line">fn3()(); <span class="comment">// 9</span></div></pre></td></tr></table></figure>
<p>当fn3()()第一次执行完后，整个fn3()被销毁，第二次fn3()相当于重新开辟了一块新的空间，所以第二次fn3()()和第一次打印的结果无关。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">fn3</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> a = <span class="number">10</span>;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        a--;</div><div class="line">        <span class="built_in">console</span>.log(a);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> val = fn3();</div><div class="line">val(); <span class="comment">// 9</span></div><div class="line">val(); <span class="comment">// 8</span></div></pre></td></tr></table></figure>
<p>当fn3第一次执行完后，val并没有被销毁，第二次是在第一次基础之上执行的，val指向的对象会永远存在堆内存中,即使是fn3已经执行完毕，需要 <code>val=null</code> 将其指向的对象释放。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/07/14/css-border-image/" itemprop="url">
                  CSS-border-image
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2020-07-14T11:07:27+08:00" content="2020-07-14">
              2020-07-14
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/CSS/" itemprop="url" rel="index">
                    <span itemprop="name">CSS</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>border-image-slice</code> 用来分解引入进来的背景图片，使图像边界向内偏移，取值为 <code>number</code> | <code>percentage</code> 其中 number 是没有单位的，专指像素 px，<code>number</code> 或<code>percentage</code> 都可取 1~4 个值，类似于 border-width 的取值方式。如果取值上还可以加上 fill，如果使用这个关键字，图片边界的中间部分将保留下来，默认情况下是为空的。</p>
<p><code>border-image-slice</code> 把通过 <code>border-image-source</code> 取到的图片切成了九份，中间一份为内容区域，其他分别对应边框的对应部分，如图 1 所示。</p>
<img src="/2020/07/14/css-border-image/slice.png" width="400" title="图1">
<p>其中，1、2、3、4 区域和内容区域水平和垂直方向均被拉伸。a、b、c、d 区域根据 <code>border-image-repeat</code> 属性值展示，是否应重复（repeat）、拉伸（stretch）或铺满（round），可取两个值，分别表示水平和垂直方向。<br><code>border-image-width</code> 指定图像边界的宽度，不改变元素本身大小。<br><code>border-image-outset</code> 用于指定在边框外部绘制的量，向元素外显示图片边框，不影响其它元素。</p>
<p>示例代码如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Untitled Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="css"></span></div><div class="line">      <span class="selector-class">.container</span> &#123;</div><div class="line">        <span class="attribute">display</span>: flex;</div><div class="line">      &#125;</div><div class="line">      <span class="selector-class">.box</span> &#123;</div><div class="line">        <span class="attribute">margin</span>: <span class="number">20px</span>;</div><div class="line">        <span class="attribute">width</span>: <span class="number">200px</span>;</div><div class="line">        <span class="attribute">height</span>: <span class="number">200px</span>;</div><div class="line">        <span class="attribute">background-color</span>: orange;</div><div class="line">        <span class="attribute">border</span>: <span class="number">100px</span> solid;</div><div class="line">        <span class="attribute">border-image-source</span>: <span class="built_in">url</span>(<span class="string">'slice.png'</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="selector-class">.box1</span> &#123;</div><div class="line">        <span class="attribute">border-image-slice</span>: <span class="number">100</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="selector-class">.box2</span> &#123;</div><div class="line">        <span class="attribute">border-image-slice</span>: <span class="number">200</span> <span class="number">100</span> <span class="number">100</span> <span class="number">100</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="selector-class">.box3</span> &#123;</div><div class="line">        <span class="attribute">border-image-slice</span>: <span class="number">200</span> <span class="number">200</span> <span class="number">100</span> <span class="number">100</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="selector-class">.box4</span> &#123;</div><div class="line">        <span class="attribute">border-image-slice</span>: <span class="number">200</span> <span class="number">100</span> <span class="number">50</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="selector-class">.box5</span> &#123;</div><div class="line">        <span class="attribute">border-image-slice</span>: <span class="number">100</span>;</div><div class="line">        <span class="attribute">border-image-repeat</span>: stretch;</div><div class="line">      &#125;</div><div class="line">      <span class="selector-class">.box6</span> &#123;</div><div class="line">        <span class="attribute">border-image-slice</span>: <span class="number">100</span>;</div><div class="line">        <span class="attribute">border-image-repeat</span>: round;</div><div class="line">      &#125;</div><div class="line">      <span class="selector-class">.box7</span> &#123;</div><div class="line">        <span class="attribute">border-image-slice</span>: <span class="number">100</span>;</div><div class="line">        <span class="attribute">border-image-repeat</span>: repeat;</div><div class="line">      &#125;</div><div class="line">      <span class="selector-class">.box8</span> &#123;</div><div class="line">        <span class="attribute">border-image-slice</span>: <span class="number">100</span>;</div><div class="line">        <span class="attribute">border-image-repeat</span>: space;</div><div class="line">      &#125;</div><div class="line">      <span class="selector-class">.box9</span> &#123;</div><div class="line">        <span class="attribute">border-image-slice</span>: <span class="number">100</span>;</div><div class="line">        <span class="attribute">border-image-width</span>: <span class="number">20px</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="selector-class">.box10</span> &#123;</div><div class="line">        <span class="attribute">border-image-slice</span>: <span class="number">100</span>;</div><div class="line">        <span class="attribute">border-image-width</span>: <span class="number">20px</span>;</div><div class="line">        <span class="attribute">border-image-outset</span>: <span class="number">20px</span>;</div><div class="line">      &#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box box1"</span>&gt;</span>内容<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box box2"</span>&gt;</span>内容<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box box3"</span>&gt;</span>内容<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box box4"</span>&gt;</span>内容<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box box5"</span>&gt;</span>内容<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box box6"</span>&gt;</span>内容<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box box7"</span>&gt;</span>内容<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box box8"</span>&gt;</span>内容<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box box9"</span>&gt;</span>内容<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box box10"</span>&gt;</span>内容<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<img src="/2020/07/14/css-border-image/border-width.png" title="运行结果">

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/07/06/npm-authorization/" itemprop="url">
                  NPM-授权安装
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2020-07-06T10:59:12+08:00" content="2020-07-06">
              2020-07-06
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/NPM/" itemprop="url" rel="index">
                    <span itemprop="name">NPM</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>问题描述：工作中遇到一个特殊的需求，部门自己研发的平台，纯前端项目，没有后端，发布为私有包，希望可以通过授权安装控制项目分摊成本。</p>
<p>任何客户端都存在同样的问题，无论如何代码都要在客户端运行，所以就目前的技术而言是无法避免文件拷贝的。但可以通过混淆、加密等手段增加对方使用代码的成本。webpack 的 uglifyjs-webpack-plugin 插件可以进行代码混淆，但是还是能搜索到一些关键字。如果要对整个 js 文件进行加密，浏览器是无法识别加密后的文件的，可以考虑只对关键信息进行加密，解密后再执行。</p>
<h2 id="方式一：输出版权信息"><a href="#方式一：输出版权信息" class="headerlink" title="方式一：输出版权信息"></a>方式一：输出版权信息</h2><p>思路：这是收费 js 的通用做法，只能限制商业运用，但任何人都可以得到你的源码。下载源码后，搜索版权信息中的关键字，很容易就能定位到这段代码，然后自己删除掉。为了不让用户轻易找到输出版权信息的代码，可以对这部分输出代码进行加密，减小用户找到这段代码的可能性。</p>
<p>借助 webpack 的 copy-webpack-plugin 插件，可以在打包时对静态资源进行加密，使用 axios 加载打包后的静态资源再进行解密，这样就可以在代码中写明文的输出信息，方便维护，打包后就是进行了加密的代码。</p>
<p>实现代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// encrypt.js 加密文件</span></div><div class="line"><span class="keyword">var</span> CryptoJS = <span class="built_in">require</span>(<span class="string">'crypto-js'</span>);</div><div class="line"><span class="keyword">var</span> config = <span class="built_in">require</span>(<span class="string">'../config'</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">encrypt</span>(<span class="params">content, path</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> str = content.toString();</div><div class="line">  <span class="comment">// 密钥 16 位</span></div><div class="line">  <span class="keyword">var</span> key = config.encrypt.key;</div><div class="line">  <span class="comment">// 初始向量 initial vector 16 位</span></div><div class="line">  <span class="keyword">var</span> iv = config.encrypt.iv;</div><div class="line">  <span class="comment">// key 和 iv 可以一致</span></div><div class="line"></div><div class="line">  key = CryptoJS.enc.Utf8.parse(key);</div><div class="line">  iv = CryptoJS.enc.Utf8.parse(iv);</div><div class="line"></div><div class="line">  <span class="keyword">var</span> encrypted = CryptoJS.AES.encrypt(str, key, &#123;</div><div class="line">    iv: iv,</div><div class="line">    mode: CryptoJS.mode.CBC,</div><div class="line">    padding: CryptoJS.pad.Pkcs7,</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="comment">// 转换为字符串</span></div><div class="line">  encrypted = encrypted.toString();</div><div class="line"></div><div class="line">  <span class="comment">// mode 支持 CBC、CFB、CTR、ECB、OFB, 默认 CBC</span></div><div class="line">  <span class="comment">// padding 支持 Pkcs7、AnsiX923、Iso10126</span></div><div class="line">  <span class="comment">// 、NoPadding、ZeroPadding, 默认 Pkcs7, 即 Pkcs5</span></div><div class="line"></div><div class="line">  <span class="keyword">return</span> encrypted;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = encrypt;</div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// decrypt.js 解密文件</span></div><div class="line"><span class="keyword">var</span> CryptoJS = <span class="built_in">require</span>(<span class="string">'crypto-js'</span>);</div><div class="line"><span class="keyword">var</span> config = <span class="built_in">require</span>(<span class="string">'../config'</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">decrypt</span>(<span class="params">content</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> key = config.encrypt.key;</div><div class="line">  <span class="keyword">var</span> iv = config.encrypt.iv;</div><div class="line"></div><div class="line">  key = CryptoJS.enc.Utf8.parse(key);</div><div class="line">  iv = CryptoJS.enc.Utf8.parse(iv);</div><div class="line"></div><div class="line">  <span class="comment">// DES 解密</span></div><div class="line">  <span class="keyword">var</span> decrypted = CryptoJS.AES.decrypt(content, key, &#123;</div><div class="line">    iv: iv,</div><div class="line">    mode: CryptoJS.mode.CBC,</div><div class="line">    padding: CryptoJS.pad.Pkcs7,</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="comment">// 转换为 utf8 字符串</span></div><div class="line">  decrypted = CryptoJS.enc.Utf8.stringify(decrypted);</div><div class="line">  <span class="keyword">return</span> decrypted;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = decrypt;</div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// webpack.config.js webpack 配置</span></div><div class="line"><span class="keyword">const</span> CopyWebpackPlugin = <span class="built_in">require</span>(<span class="string">'copy-webpack-plugin'</span>)</div><div class="line">...</div><div class="line">plugins: [</div><div class="line">  <span class="keyword">new</span> CopyWebpackPlugin([</div><div class="line">    &#123;</div><div class="line">      <span class="keyword">from</span>: path.resolve(__dirname, <span class="string">'../../static/info'</span>),</div><div class="line">      to: <span class="string">'static'</span>,</div><div class="line">      transform (content, path) &#123;</div><div class="line">        <span class="keyword">return</span> encrypt(content, path)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  ]),</div><div class="line">]</div><div class="line"></div><div class="line"><span class="comment">// static/info 输入版权信息的静态文件</span></div><div class="line"><span class="built_in">console</span>.log(</div><div class="line">  <span class="string">'%c未授权 xxxx公司 版权所有 copyright@2020'</span>,</div><div class="line">  <span class="string">'\n\tfont-size: 16px;\n\tcolor: red;\n'</span></div><div class="line">);</div><div class="line"></div><div class="line"><span class="comment">// 代码中读取加密后的静态文件，解密后执行</span></div><div class="line">axios.get(<span class="string">'static/info'</span>).then(result =&gt; &#123;</div><div class="line">  <span class="built_in">eval</span>(decrypt(result.data));</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="方案二：授权安装"><a href="#方案二：授权安装" class="headerlink" title="方案二：授权安装"></a>方案二：授权安装</h2><p>思路：利用 NPM 的 preinstall 钩子，可以在输入 npm install 后，安装包之前，执行一个 Node.js 脚本，在这个脚本中，可以要求用户输入一个 token 到后端进行校验，也可以拿到 mac 地址到后端请求进行验证，也可以拿项目目录下的授权文件，解密后校验，如果可以安装则继续，如果不可以安装则中断安装。</p>
<p>实现代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> os = <span class="built_in">require</span>(<span class="string">'os'</span>);</div><div class="line"><span class="keyword">const</span> chalk = <span class="built_in">require</span>(<span class="string">'chalk'</span>);</div><div class="line"><span class="keyword">const</span> getMAC = <span class="built_in">require</span>(<span class="string">'getmac'</span>);</div><div class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"></div><div class="line"><span class="comment">// 输出 mac 地址，可做校验</span></div><div class="line"><span class="built_in">console</span>.log(getMAC.default());</div><div class="line"></div><div class="line"><span class="comment">// 读取项目目录下 static/config.json 文件，可做校验</span></div><div class="line"><span class="keyword">const</span> configJSON = <span class="built_in">require</span>(path.resolve(</div><div class="line">  process.cwd(),</div><div class="line">  <span class="string">'../../static/config.json'</span></div><div class="line">));</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'===='</span>, configJSON);</div><div class="line"></div><div class="line"><span class="comment">// 用户输入指定信息，可做校验</span></div><div class="line">process.stdout.write(<span class="string">`<span class="subst">$&#123;chalk.cyan('Please input token:')&#125;</span>`</span>);</div><div class="line">process.stdin.on(<span class="string">'data'</span>, (input) =&gt; &#123;</div><div class="line">  <span class="keyword">const</span> token = input.toString().trim();</div><div class="line">  <span class="keyword">if</span> (token !== <span class="string">'aaa'</span>) &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'认证失败，结束安装！'</span>);</div><div class="line">    process.exit(<span class="number">1</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'认证成功，开始安装...'</span>);</div><div class="line">  process.stdin.pause();</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>但是这种方式还是存在问题，主要问题是在不同环境下执行安装包命令时获取的 mac 地址可能不正确，如在容器中执行，或 CI 的线上环境。而且包一旦被安装了，就在项目的 node_modules 目录下了，一是可以通过拷贝的方式泄露，二是安装到本地后执行解密的代码就泄露了。</p>
<h2 id="方式三：授权运行"><a href="#方式三：授权运行" class="headerlink" title="方式三：授权运行"></a>方式三：授权运行</h2><p>思路：不控制安装，所有人都可以进行安装包的操作，使用时需要给项目一个加密的授权文件，运行时拿到这个授权文件，解密后进行校验，如果正确则向下运行，否则终止运行。这就要求授权文件中被加密的信息要是运行时能拿到的信息，并且具有唯一性，由于客户端是没办法获取 mac 地址的，可以使用域名和时间的方式进行加密。运行时获取授权文件，判断如果是生产环境授权文件，进行域名和端口号的校验，如果是开发环境授权文件，则校验授权日期和过期天数。</p>
<p>生成授权文件时我们向用户要了域名，那用户就知道我们是使用了域名进行校验，肯定有获取域名的代码，在代码中搜索 <code>location.host</code> 很容易定位到进行校验的代码，仔细读读就可以进行破解，因此希望能对这段校验的代码进行加密。我们使用方案一中对静态资源加密的方式，把校验逻辑的代码写在一个静态文件中。注意这里不能把整个校验逻辑写成一个完整的方法放在静态文件中导出使用，因为这个文件没有被 babel 处理，解密后的文件中会存在 import 等浏览器无法识别的关键字。</p>
<p>最后为了使用方便，还需要一个能生成授权文件的脚本。</p>
<p>实现代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// generateLicense.js 生成授权文件</span></div><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> chalk = <span class="built_in">require</span>(<span class="string">'chalk'</span>);</div><div class="line"><span class="keyword">var</span> encrypt = <span class="built_in">require</span>(<span class="string">'./encrypt'</span>);</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * static/license 为加密前的明文文件</div><div class="line"> * 生产环境指定 type 为 production，添加 domains</div><div class="line"> * 开发环境指定 type 为 development，添加 created 创建时间、expired 过期天数</div><div class="line"> */</div><div class="line"><span class="keyword">const</span> buffer = fs.readFileSync(path.resolve(__dirname, <span class="string">'../static/license'</span>));</div><div class="line"></div><div class="line"><span class="comment">// 写入文件，项目根目录下 license，不会被提交</span></div><div class="line"><span class="keyword">var</span> ws = fs.createWriteStream(<span class="string">'./license'</span>);</div><div class="line">ws.write(encrypt(buffer));</div><div class="line">ws.end();</div><div class="line"><span class="built_in">console</span>.log(chalk.green(<span class="string">'已生成 license 文件'</span>));</div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// webpack.config.js webpack 配置</span></div><div class="line"><span class="keyword">const</span> CopyWebpackPlugin = <span class="built_in">require</span>(<span class="string">'copy-webpack-plugin'</span>)</div><div class="line">...</div><div class="line">plugins: [</div><div class="line">  <span class="keyword">new</span> CopyWebpackPlugin([</div><div class="line">    &#123;</div><div class="line">      <span class="keyword">from</span>: path.resolve(__dirname, <span class="string">'../../static/validate'</span>),</div><div class="line">      to: <span class="string">'static'</span>,</div><div class="line">      transform (content, path) &#123;</div><div class="line">        <span class="keyword">return</span> encrypt(content, path)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  ]),</div><div class="line">]</div><div class="line"></div><div class="line"><span class="comment">// 项目入口进行授权校验</span></div><div class="line"><span class="comment">/* eslint-disable */</span></div><div class="line"><span class="keyword">let</span> validate = <span class="literal">false</span>;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">  <span class="comment">// 获取授权文件</span></div><div class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> axios.get(<span class="string">'static/license'</span>);</div><div class="line">  <span class="keyword">const</span> FORMAT = <span class="string">'YYYY-MM-DD'</span>;</div><div class="line">  <span class="keyword">const</span> str = decrypt(result.data);</div><div class="line">  <span class="keyword">const</span> data = <span class="built_in">JSON</span>.parse(str);</div><div class="line">  <span class="keyword">const</span> nowDate = moment().format(FORMAT);</div><div class="line">  <span class="comment">// 获取加密后的校验逻辑文件，执行校验</span></div><div class="line">  <span class="keyword">const</span> validate = <span class="keyword">await</span> axios.get(<span class="string">'static/validate'</span>)</div><div class="line">  <span class="built_in">eval</span>(decrypt(validate.data));</div><div class="line">&#125; <span class="keyword">catch</span> (error) &#123;</div><div class="line">  <span class="built_in">console</span>.error(error);</div><div class="line">&#125;</div><div class="line"><span class="comment">/* eslint-enable */</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> (!validate) &#123;</div><div class="line">  <span class="comment">// 校验失败处理</span></div><div class="line">  <span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 校验通过，向下运行</span></div><div class="line">...</div><div class="line"></div><div class="line"><span class="comment">// static/validate 校验逻辑静态文件</span></div><div class="line"><span class="keyword">if</span> (data.type === <span class="string">'production'</span> &amp;&amp; data.domains.includes(<span class="built_in">window</span>.location.host)) &#123;</div><div class="line">  validate = <span class="literal">true</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (data.type === <span class="string">'development'</span>) &#123;</div><div class="line">  <span class="keyword">const</span> expiredDate = moment(data.created, <span class="string">'YYYY-MM-DD'</span>)</div><div class="line">    .add(data.expired, <span class="string">'days'</span>)</div><div class="line">    .format(<span class="string">'YYYY-MM-DD'</span>);</div><div class="line">  <span class="keyword">if</span> (nowDate &lt;= expiredDate) &#123;</div><div class="line">    validate = <span class="literal">true</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/06/12/gitlab-pull-request/" itemprop="url">
                  GitLab 代码审核
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2020-06-12T10:10:05+08:00" content="2020-06-12">
              2020-06-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Git/" itemprop="url" rel="index">
                    <span itemprop="name">Git</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="设置钉钉-GitLab-机器人"><a href="#设置钉钉-GitLab-机器人" class="headerlink" title="设置钉钉 GitLab 机器人"></a>设置钉钉 GitLab 机器人</h2><p>打开钉钉，在需要配置 GitLab 机器人的群中，点击【群设置】→【智能群助手】→【添加机器人】→【GitLab】→【添加】，复制生成的 Webhook 地址备用。</p>
<p>进行如下 GitLab 配置。</p>
<img src="/2020/06/12/gitlab-pull-request/integration.png" title="设置钉钉 webhook">
<h2 id="GitLab-代码审核配置"><a href="#GitLab-代码审核配置" class="headerlink" title="GitLab 代码审核配置"></a>GitLab 代码审核配置</h2><img src="/2020/06/12/gitlab-pull-request/branch.png" title="分支设置">
<img src="/2020/06/12/gitlab-pull-request/merge-request.png" title="设置 merge request">
<p>开发人员创建一个 merge request，然后线下 @审核人 进行代码审核，添加评论，开发人员解决评论中的问题，重复这个步骤直至所有评论解决后，线下 @Maintainer 进行合并。</p>
<p>代码审核要求：</p>
<ul>
<li>格式规范</li>
<li>变量名称要是单词，符合语义</li>
<li>局部逻辑，尽量简化</li>
<li>复杂逻辑要补充注释</li>
<li>一个组件不要写的太复杂，适当拆分</li>
<li>公共模块需要提取</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/06/12/vscode-plugin/" itemprop="url">
                  VSCode 插件
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2020-06-12T10:09:39+08:00" content="2020-06-12">
              2020-06-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/VSCode/" itemprop="url" rel="index">
                    <span itemprop="name">VSCode</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="常用插件"><a href="#常用插件" class="headerlink" title="常用插件"></a>常用插件</h2><p><a href="https://marketplace.visualstudio.com/items?itemName=formulahendry.auto-close-tag" target="_blank" rel="external">Auto Close Tag</a> 自动闭合 HTML 标签</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=formulahendry.auto-rename-tag" target="_blank" rel="external">Auto Rename Tag</a> 自动修改匹配的标签</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=JerryHong.autofilename" target="_blank" rel="external">AutoFileName</a> 输入的文件路径的智能补全</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=ionutvmi.path-autocomplete" target="_blank" rel="external">Path Autocomplete</a> 文件路径补全，可设置别名</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=christian-kohler.path-intellisense" target="_blank" rel="external">Path Intellisense</a> 文件路径补全</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=aaron-bond.better-comments" target="_blank" rel="external">Better Comments</a> 美化注释</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=CoenraadS.bracket-pair-colorizer" target="_blank" rel="external">Bracket Pair Colorizer</a> 为括号提供颜色高亮</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=streetsidesoftware.code-spell-checker" target="_blank" rel="external">Code Spell Checker</a> 拼写检查</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=naumovs.color-highlight" target="_blank" rel="external">Color Highlight</a> 颜色值在代码中高亮显示</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=joelday.docthis" target="_blank" rel="external">Document This</a> 注释文档生成</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=mikestead.dotenv" target="_blank" rel="external">DotENV</a> DotENV 插件</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=EditorConfig.EditorConfig" target="_blank" rel="external">EditorConfig for VS Code</a> EditorConfig 插件</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint" target="_blank" rel="external">ESLint</a> ESLint 插件，高亮提示</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=donjayamanne.githistory" target="_blank" rel="external">Git History</a> 查看 Git log</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=codezombiech.gitignore" target="_blank" rel="external">gitignore</a> 更好的使用 gitignore</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=eamodio.gitlens" target="_blank" rel="external">GitLens — Git supercharged</a> 显示当前行commit信息</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=oderwat.indent-rainbow" target="_blank" rel="external">indent-rainbow</a> 突出显示代码缩进</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=DavidAnson.vscode-markdownlint" target="_blank" rel="external">markdownlint</a> markdown 格式检查</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=PKief.material-icon-theme" target="_blank" rel="external">Material Icon Theme</a> 设置文件图标</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=pnp.polacode" target="_blank" rel="external">Polacode</a> 代码截图工具</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=esbenp.prettier-vscode" target="_blank" rel="external">Prettier - Code formatter</a> Prettier 插件</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=stylelint.vscode-stylelint" target="_blank" rel="external">stylelint</a> stylelint 插件</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=Tyriar.sort-lines" target="_blank" rel="external">Sort lines</a> 排序选中行</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=octref.vetur" target="_blank" rel="external">Vetur</a> Vue 语法高亮</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=VisualStudioExptTeam.vscodeintellicode" target="_blank" rel="external">Visual Studio IntelliCode</a> 代码智能提示</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=peakchen90.vue-beautify" target="_blank" rel="external">vue-beautify</a> vue 格式化</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=shenjiaolong.vue-helper" target="_blank" rel="external">vue-helper</a> Vue2 代码片段</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=Shan.code-settings-sync" target="_blank" rel="external">Settings Sync</a> 设置同步</p>
<p><a href="https://marketplace.visualstudio.com/items?itemName=jasonnutter.search-node-modules" target="_blank" rel="external">Search node_modules</a> 搜索node_modules下目录</p>
<h2 id="Settings-Sync-使用"><a href="#Settings-Sync-使用" class="headerlink" title="Settings Sync 使用"></a>Settings Sync 使用</h2><h3 id="上传设置"><a href="#上传设置" class="headerlink" title="上传设置"></a>上传设置</h3><ul>
<li>需要 GitHub 账号</li>
<li>安装 Settings Sync 插件</li>
<li>cmd + shift + p，输入 Sync:Advanced Options，LOGIN WITH GITHUB</li>
<li><a href="https://github.com/settings/tokens" target="_blank" rel="external">生成 Github Token</a></li>
<li>Gist ID，输入上步获取的 Token</li>
<li>cmd + shift + p，输入 Sync:Upload/Update Settings 上传设置</li>
</ul>
<h3 id="下载设置"><a href="#下载设置" class="headerlink" title="下载设置"></a>下载设置</h3><ul>
<li>cmd + shift + p，输入 Sync:Advanced Options，LOGIN WITH GITHUB</li>
<li>输入 Gist ID 和 获取令牌</li>
<li>cmd + shift + p，输入 Sync:Download Settings 下载设置</li>
<li>若未下载成功，多尝试几次，注意确认 Gist ID 和 获取令牌是否正确</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/06/12/jszip/" itemprop="url">
                  JSZip 简单使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2020-06-12T10:08:00+08:00" content="2020-06-12">
              2020-06-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index">
                    <span itemprop="name">JavaScript</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://github.com/Stuk/jszip" target="_blank" rel="external">JSZip</a> 是一个用于创建、读取和编辑.zip文件的JavaScript库，且API的使用也很简单。如下是使用 JSZip 压缩一个文件夹到指定目录的例子。</p>
<p>zip.js 文件中内容如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"><span class="keyword">let</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">let</span> JsZip = <span class="built_in">require</span>(<span class="string">'jszip'</span>);</div><div class="line"><span class="keyword">let</span> zip = <span class="keyword">new</span> JsZip();</div><div class="line"></div><div class="line"><span class="comment">// 读取目录及文件</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">readDir</span>(<span class="params">obj, nowPath, nowFolder</span>) </span>&#123;</div><div class="line">  <span class="comment">// 读取目录中的所有文件及文件夹</span></div><div class="line">  <span class="keyword">let</span> files = fs.readdirSync(nowPath);</div><div class="line">  files.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">fileName, index</span>) </span>&#123;</div><div class="line">    <span class="comment">// 遍历检测目录中的文件</span></div><div class="line">    <span class="keyword">let</span> fillPath = nowPath + <span class="string">'/'</span> + fileName;</div><div class="line">    <span class="keyword">let</span> file = fs.statSync(fillPath);</div><div class="line">    <span class="keyword">if</span> (file.isDirectory()) &#123;</div><div class="line">      <span class="comment">// 如果是目录的话，继续查询</span></div><div class="line">      <span class="keyword">let</span> folder = nowFolder + <span class="string">'/'</span> + fileName;</div><div class="line">      <span class="comment">// 压缩对象中生成该目录</span></div><div class="line">      <span class="keyword">let</span> dirList = zip.folder(folder);</div><div class="line">      <span class="comment">// 重新检索目录文件</span></div><div class="line">      readDir(dirList, fillPath, folder);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="comment">// 如果是文件压缩目录添加文件</span></div><div class="line">      obj.file(fileName, fs.readFileSync(fillPath));</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 开始压缩文件</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">startZIP</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> currPath = __dirname;</div><div class="line">  <span class="comment">// 要压缩的文件夹目录</span></div><div class="line">  <span class="keyword">var</span> sourceDir = path.join(currPath, <span class="string">'../../dist:source/'</span>);</div><div class="line">  <span class="comment">// 生成压缩包的目录</span></div><div class="line">  <span class="keyword">var</span> targetDir = path.join(currPath, <span class="string">'../../dist:app/static/source.zip'</span>);</div><div class="line">  readDir(zip, sourceDir, <span class="string">''</span>);</div><div class="line">  zip</div><div class="line">    .generateAsync(&#123;</div><div class="line">      type: <span class="string">'nodebuffer'</span>,</div><div class="line">      compression: <span class="string">'DEFLATE'</span>,</div><div class="line">      compressionOptions: &#123;</div><div class="line">        level: <span class="number">9</span>,</div><div class="line">      &#125;,</div><div class="line">    &#125;)</div><div class="line">    .then(<span class="function"><span class="keyword">function</span> (<span class="params">content</span>) </span>&#123;</div><div class="line">      fs.writeFileSync(targetDir, content, <span class="string">'utf-8'</span>);</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">'压缩完成'</span>);</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">startZIP();</div></pre></td></tr></table></figure>
<p>命令：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">node zip.js</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/06/12/webpack-build/" itemprop="url">
                  Webpack 打包
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2020-06-12T10:06:02+08:00" content="2020-06-12">
              2020-06-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Webpack/" itemprop="url" rel="index">
                    <span itemprop="name">Webpack</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="安装包后自动将文件从软件包复制到本地目录"><a href="#安装包后自动将文件从软件包复制到本地目录" class="headerlink" title="安装包后自动将文件从软件包复制到本地目录"></a>安装包后自动将文件从软件包复制到本地目录</h2><p>npm 的 postinstall 脚本会在安装完包后自动执行。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="string">"scripts"</span>: &#123;</div><div class="line">  <span class="string">"postinstall"</span>: <span class="string">"node bin/copy.js"</span></div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<h2 id="webpack-打包后可通过-import-引入、script-标签引入"><a href="#webpack-打包后可通过-import-引入、script-标签引入" class="headerlink" title="webpack 打包后可通过 import 引入、script 标签引入"></a>webpack 打包后可通过 import 引入、script 标签引入</h2><ul>
<li><code>output.libraryTarget</code> 打包类库的发布模式，使用 <code>umd</code> 可通过 <code>import</code> 方式引入</li>
<li><code>output.library</code> 为导出的库指定义一个全局使用的名称变量，主要用于直接引用的方式，如用 script 标签</li>
<li><code>output.libraryExport</code> 库中被导出的项，如对外暴露 default 属性，就可以直接调用 default 里的属性</li>
</ul>
<p>配置以下内容即可实现 webpack 打包后的包可通过 import 和 script 标签引入。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">output: &#123;</div><div class="line">  path: config.buildSource.assetsRoot,</div><div class="line">  filename: <span class="string">'index.js'</span>,</div><div class="line">  libraryTarget: <span class="string">'umd'</span>,</div><div class="line">  libraryExport: <span class="string">'default'</span>,</div><div class="line">  library: config.buildSource.name,</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// import 方式</span></div><div class="line"><span class="keyword">import</span> Library <span class="keyword">from</span> <span class="string">'lib'</span>;</div><div class="line"></div><div class="line"><span class="comment">// script 标签方式</span></div><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">  &lt;head&gt;</div><div class="line">    &lt;meta charset="utf-8"&gt;</div><div class="line">    &lt;meta name="viewport" content="width=device-width,initial-scale=1.0"&gt;</div><div class="line">    &lt;link rel="stylesheet" href="./lib.css"/&gt;</div><div class="line">    &lt;script src="./lib.js"&gt;&lt;/script&gt;</div><div class="line">    &lt;title&gt;测试包引入&lt;/title&gt;</div><div class="line">  &lt;/head&gt;</div><div class="line">  &lt;body&gt;</div><div class="line">    &lt;div id="app"&gt;&lt;/div&gt;</div><div class="line">    &lt;script&gt;</div><div class="line">      const viewer = new Library.App.Viewer("app");</div><div class="line">    &lt;/script&gt;</div><div class="line">  &lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<h2 id="添加对下载时需要的静态资源的处理，下载页面"><a href="#添加对下载时需要的静态资源的处理，下载页面" class="headerlink" title="添加对下载时需要的静态资源的处理，下载页面"></a>添加对下载时需要的静态资源的处理，下载页面</h2><p>类库提供了下载链接可直接下载使用，这就需要维护所有版本的下载压缩包，放在指定的文件夹中，在 webpack.config.js 中，通过 node 的 fs 模块读取文件夹中的文件列表，放到一个变量中，再通过 webpack.DefinePlugin 暴露成全局变量，页面中就可以取到压缩文件列表了。注意，在项目启动后修改下载列表中的文件需要重启。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> files = fs.readdirSync(path.join(__dirname, <span class="string">'../../static/app/source/'</span>));</div><div class="line">files.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">fileName</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (fileName.endsWith(<span class="string">'.zip'</span>)) &#123;</div><div class="line">    sourceZipList.push(fileName);</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line">...</div><div class="line">plugins: [</div><div class="line">  <span class="keyword">new</span> webpack.DefinePlugin(&#123;</div><div class="line">    <span class="string">'sourceZipList'</span>: <span class="built_in">JSON</span>.stringify(sourceZipList),</div><div class="line">  &#125;),</div><div class="line">  ...</div><div class="line">]</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/06/12/jsdoc/" itemprop="url">
                  JSDoc javascript 注释
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2020-06-12T10:05:05+08:00" content="2020-06-12">
              2020-06-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index">
                    <span itemprop="name">JavaScript</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://github.com/jsdoc/jsdoc" target="_blank" rel="external">JSDoc</a> 是根据 JavaScript 文件中的注释信息，生成静态文件的工具，使用简单方便。</p>
<p><a href="https://jsdoc.app/" target="_blank" rel="external">JSDoc 官方文档</a><br><a href="https://jsdoc.zcopy.site/" target="_blank" rel="external">JSDoc 中文文档</a></p>
<p>在使用 JSDoc 时，发现无法定义指向项目内的链接。<code>@link</code> 和 <code>@see</code> 语法创建内联标签连接到文档中的其它项 或 外部URL，无法使用相对路径连接到项目内的地址，但可以通过自定义插件实现该功能。</p>
<p>plugins/demo.js 文件中内容如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// demo&#123;/#/cesium|参考样例&#125;</span></div><div class="line">exports.handlers = &#123;</div><div class="line">  beforeParse: (e) =&gt; &#123;</div><div class="line">    <span class="keyword">const</span> result = e.source.match(<span class="regexp">/demo\&#123;[^\&#125;]+\&#125;/</span>);</div><div class="line">    <span class="keyword">if</span> (result &amp;&amp; result[<span class="number">0</span>]) &#123;</div><div class="line">      <span class="keyword">const</span> value = result[<span class="number">0</span>].replace(<span class="string">'demo&#123;'</span>, <span class="string">''</span>).replace(<span class="string">'&#125;'</span>, <span class="string">''</span>).split(<span class="string">'|'</span>);</div><div class="line">      <span class="keyword">if</span> (value &amp;&amp; value.length &gt; <span class="number">1</span>) &#123;</div><div class="line">        e.source = e.source.replace(result[<span class="number">0</span>], <span class="string">`&lt;a href="<span class="subst">$&#123;value[0]&#125;</span>"&gt;<span class="subst">$&#123;value[1]&#125;</span>&lt;/a&gt;`</span>);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>conf.json 文件中内容如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"plugins"</span>: [<span class="string">"plugins/demo"</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>命令</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jsdoc -c conf.json source<span class="comment">/**/</span>* -d <span class="keyword">static</span>/doc</div></pre></td></tr></table></figure>
<img src="/2020/06/12/jsdoc/jsdoc.png" title="样例">

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/05/22/es6-module/" itemprop="url">
                  ES6-Module
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2020-05-22T16:13:43+08:00" content="2020-05-22">
              2020-05-22
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/ES6/" itemprop="url" rel="index">
                    <span itemprop="name">ES6</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>历史上，JavaScript 一直没有模块（module）体系，无法将一个大程序拆分成互相依赖的小文件，再用简单的方法拼装起来。在 ES6 之前，社区制定了一些模块加载方案，最主要的有 CommonJS 和 AMD 两种。前者用于服务器，后者用于浏览器。ES6 在语言标准的层面上，实现了模块功能，而且实现得相当简单，完全可以取代 CommonJS 和 AMD 规范，成为浏览器和服务器通用的模块解决方案。</p>
<p>ES6 模块的设计思想是尽量的静态化，使得编译时就能确定模块的依赖关系，以及输入和输出的变量。CommonJS 和 AMD 模块，都只能在运行时确定这些东西，导致完全没办法在编译时做“静态优化”。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// CommonJS 模块就是对象，输入时必须查找对象属性。这种加载称为“运行时加载”，因为只有运行时才能得到这个对象。</span></div><div class="line"><span class="keyword">let</span> &#123; stat, exists, readfile &#125; = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"></div><div class="line"><span class="comment">// 等同于</span></div><div class="line"><span class="keyword">let</span> _fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"><span class="keyword">let</span> stat = _fs.stat;</div><div class="line"><span class="keyword">let</span> exists = _fs.exists;</div><div class="line"><span class="keyword">let</span> readfile = _fs.readfile;</div><div class="line"></div><div class="line"><span class="comment">// ES6 模块不是对象，而是通过 export 命令显式指定输出的代码，再通过 import 命令输入指定方法，其他方法不加载。这种加载称为“编译时加载”或者静态加载。</span></div><div class="line"><span class="keyword">import</span> &#123; stat, exists, readFile &#125; <span class="keyword">from</span> <span class="string">'fs'</span>;</div></pre></td></tr></table></figure>
<p>ES6 模块还有以下好处：</p>
<ul>
<li>静态加载</li>
<li>不再需要 UMD 模块格式了，将来服务器和浏览器都会支持 ES6 模块格式</li>
<li>将来浏览器的新 API 就能用模块格式提供，不再必须做成全局变量或者 <code>navigator</code> 对象的属性</li>
<li>不再需要对象作为命名空间（比如 Math 对象），未来这些功能可以通过模块提供</li>
</ul>
<p>模块功能主要由两个命令构成：<code>export</code> 和 <code>import</code>。<code>export</code> 命令用于规定模块的对外接口，<code>import</code> 命令用于输入其他模块提供的功能。<code>import</code> 和 <code>export</code> 命令只能在模块的顶层，不能在代码块之中。</p>
<p><code>export</code> 命令用于规定模块的对外接口，必须与模块内部的变量建立一一对应关系，<code>export</code> 语句输出的接口，与其对应的值是动态绑定关系，即通过该接口，可以取到模块内部实时的值。<code>export</code> 命令可以出现在模块的任何位置，只要处于模块顶层就可以。可以用 <code>as</code> 重命名，可以用不同的名字输出两次。<code>export default</code> 命令，为模块指定默认输出，一个模块只能有一个默认输出，<code>export default</code> 就是输出一个叫做 <code>default</code> 的变量或方法，然后系统允许你为它取任意名字。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">var</span> firstName = <span class="string">'Michael'</span>;</div><div class="line"><span class="keyword">export</span> <span class="keyword">var</span> lastName = <span class="string">'Jackson'</span>;</div><div class="line"><span class="keyword">export</span> <span class="keyword">var</span> year = <span class="number">1958</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span> firstName = <span class="string">'Michael'</span>;</div><div class="line"><span class="keyword">var</span> lastName = <span class="string">'Jackson'</span>;</div><div class="line"><span class="keyword">var</span> year = <span class="number">1958</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> &#123; firstName, lastName, year &#125;;</div><div class="line"></div><div class="line"><span class="keyword">export</span> &#123;</div><div class="line">  firstName <span class="keyword">as</span> f,</div><div class="line">  lastName <span class="keyword">as</span> l,</div><div class="line">  lastName <span class="keyword">as</span> L</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">multiply</span>(<span class="params">x, y</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> x * y;</div><div class="line">&#125;;</div><div class="line"><span class="comment">// 默认输出</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'foo'</span>);</div><div class="line">&#125;</div><div class="line"><span class="comment">// 因为 export default 命令的本质是将后面的值，赋给 default 变量，所以可以直接将一个值写在 export default 之后</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="number">42</span>;</div></pre></td></tr></table></figure>
<p><code>import</code> 命令用于输入其他模块提供的功能。如果想为输入的变量重新取一个名字，<code>import</code> 命令要使用 <code>as</code> 关键字，将输入的变量重命名。<code>import</code> 命令输入的变量都是只读的，因为它的本质是输入接口。如果输入的变量是一个对象，改写属性是允许的。<code>import</code> 命令具有提升效果，会提升到整个模块的头部，首先执行。由于 <code>import</code> 是静态执行，所以不能使用表达式和变量、if 语句，这些只有在运行时才能得到结果的语法结构。<code>import</code> 语句会执行所加载的模块。如果多次重复执行同一句 <code>import</code> 语句，那么只会执行一次，而不会执行多次。除了指定加载某个输出值，还可以使用整体加载，即用星号（<code>*</code>）指定一个对象，所有输出值都加载在这个对象上面，这个对象应该是可以静态分析的，所以不允许运行时改变。加载默认模块时，<code>import</code> 命令可以为该匿名函数指定任意名字。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; firstName, lastName, year &#125; <span class="keyword">from</span> <span class="string">'./profile.js'</span>;</div><div class="line"></div><div class="line"><span class="keyword">import</span> &#123; lastName <span class="keyword">as</span> surname &#125; <span class="keyword">from</span> <span class="string">'./profile.js'</span>;</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">'lodash'</span>;</div><div class="line"></div><div class="line"><span class="keyword">import</span> * <span class="keyword">as</span> circle <span class="keyword">from</span> <span class="string">'./circle'</span>;</div><div class="line"><span class="comment">// 加载默认输出</span></div><div class="line"><span class="keyword">import</span> customName <span class="keyword">from</span> <span class="string">'./export-default'</span>;</div></pre></td></tr></table></figure>
<p>如果在一个模块之中，先输入后输出同一个模块，<code>import</code> 语句可以与 <code>export</code> 语句写在一起。但需要注意的是，写成一行以后，<code>foo</code> 和 <code>bar</code> 实际上并没有被导入当前模块，只是相当于对外转发了这两个接口，导致当前模块不能直接使用 <code>foo</code> 和 <code>bar</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> &#123; foo, bar &#125; <span class="keyword">from</span> <span class="string">'my_module'</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> &#123; foo <span class="keyword">as</span> myFoo &#125; <span class="keyword">from</span> <span class="string">'my_module'</span>;</div><div class="line"><span class="comment">// 忽略 my_module 模块的 default 方法</span></div><div class="line"><span class="keyword">export</span> * <span class="keyword">from</span> <span class="string">'my_module'</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> &#123; <span class="keyword">default</span> &#125; <span class="keyword">from</span> <span class="string">'foo'</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> &#123; es6 <span class="keyword">as</span> <span class="keyword">default</span> &#125; <span class="keyword">from</span> <span class="string">'./someModule'</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> &#123; <span class="keyword">default</span> <span class="keyword">as</span> es6 &#125; <span class="keyword">from</span> <span class="string">'./someModule'</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> * <span class="keyword">as</span> ns <span class="keyword">from</span> <span class="string">"mod"</span>;</div><div class="line"><span class="comment">// 等同于</span></div><div class="line"><span class="keyword">import</span> * <span class="keyword">as</span> ns <span class="keyword">from</span> <span class="string">"mod"</span>;</div><div class="line"><span class="keyword">export</span> &#123;ns&#125;;</div></pre></td></tr></table></figure>
<p>ES2020提案 引入 <code>import()</code> 函数，支持动态加载模块。<code>import</code> 命令能够接受什么参数，<code>import()</code> 函数就能接受什么参数，两者区别主要是后者为动态加载。<code>import()</code> 返回一个 <code>Promise</code> 对象。 <code>import()</code> 函数可以用在任何地方，不仅仅是模块，非模块的脚本也可以使用。<code>import()</code> 函数与所加载的模块没有静态连接关系，这点也是与 <code>import</code> 语句不相同。<code>import()</code> 类似于 Node 的 <code>require</code> 方法，区别主要是前者是异步加载，后者是同步加载。<code>import()</code> 适用于按需加载、条件加载、动态的模块路径。<code>import()</code> 加载模块成功以后，这个模块会作为一个对象，当作 <code>then</code> 方法的参数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> main = <span class="built_in">document</span>.querySelector(<span class="string">'main'</span>);</div><div class="line"></div><div class="line"><span class="keyword">import</span>(<span class="string">`./section-modules/<span class="subst">$&#123;someVariable&#125;</span>.js`</span>)</div><div class="line">  .then(<span class="built_in">module</span> =&gt; &#123;</div><div class="line">    <span class="built_in">module</span>.loadPageInto(main);</div><div class="line">  &#125;)</div><div class="line">  .catch(err =&gt; &#123;</div><div class="line">    main.textContent = err.message;</div><div class="line">  &#125;);</div></pre></td></tr></table></figure>
<p>HTML 网页中，浏览器通过 <code>&lt;script&gt;</code> 标签加载 JavaScript 脚本，默认情况下，浏览器是同步加载 JavaScript 脚本。这显然是很不好的体验，所以浏览器允许脚本异步加载，下面就是两种异步加载的语法。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"path/to/myModule.js"</span> <span class="attr">defer</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"path/to/myModule.js"</span> <span class="attr">async</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure>
<p><code>defer</code> 与 <code>async</code> 的区别是：<code>defer</code> 要等到整个页面在内存中正常渲染结束（DOM 结构完全生成，以及其他脚本执行完成），才会执行；<code>async</code> 一旦下载完，渲染引擎就会中断渲染，执行这个脚本以后，再继续渲染。一句话，<code>defer</code> 是“渲染完再执行”，<code>async</code> 是“下载完就执行”。另外，如果有多个 <code>defer</code> 脚本，会按照它们在页面出现的顺序加载，而多个 <code>async</code> 脚本是不能保证加载顺序的。</p>
<p>浏览器加载 ES6 模块，也使用 <code>&lt;script&gt;</code> 标签，但是要加入 <code>type=&quot;module&quot;</code> 属性。浏览器对于带有 <code>type=&quot;module&quot;</code> 的 <code>&lt;script&gt;</code>，都是异步加载，不会造成堵塞浏览器，即等到整个页面渲染完，再执行模块脚本，等同于打开了 <code>&lt;script&gt;</code> 标签的 <code>defer</code> 属性。<code>&lt;script&gt;</code> 标签的 <code>async</code> 属性也可以打开，这时只要加载完成，渲染引擎就会中断渲染立即执行。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"module"</span> <span class="attr">src</span>=<span class="string">"./foo.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure>
<p>代码是在模块作用域之中运行，而不是在全局作用域运行。模块内部的顶层变量，外部不可见。模块脚本自动采用严格模式，不管有没有声明use strict。模块之中，顶层的 <code>this</code> 关键字返回 <code>undefined</code>，而不是指向 <code>window</code>。也就是说，在模块顶层使用 <code>this</code> 关键字，是无意义的。同一个模块如果加载多次，将只执行一次。<strong>利用顶层的 <code>this</code> 等于 <code>undefined</code> 这个语法点，可以侦测当前代码是否在 ES6 模块之中。</strong></p>
<p>ES6 模块与 CommonJS 模块完全不同：</p>
<ul>
<li>CommonJS 模块输出的是一个值的拷贝，ES6 模块输出的是值的引用</li>
<li>CommonJS 模块是运行时加载，ES6 模块是编译时输出接口</li>
</ul>
<p>Node.js 要求，<code>.mjs</code> 文件总是以 ES6 模块加载，<code>.cjs</code> 文件总是以 CommonJS 模块加载，<code>.js</code> 文件的加载取决于 <code>package.json</code> 里面 <code>type</code> 字段的设置，取值为 <code>module</code> 或 <code>commonjs</code>。</p>
<p><code>package.json</code> 文件有两个字段可以指定模块的入口文件：<code>main</code> 和 <code>exports</code>，<code>exports</code> 字段的优先级高于 <code>main</code> 字段。<code>exports</code> 有多种用法：</p>
<ul>
<li>可以指定脚本或子目录的别名</li>
<li>别名如果是<code>.</code>，就代表模块的主入口，优先级高于 <code>main</code> 字段，可以简写成 <code>exports</code>字段的值</li>
<li>条件加载，利用 <code>.</code> 这个别名，可以为 ES6 模块和 CommonJS 指定不同的入口</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 指定脚本或子目录的别名</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"exports"</span>: &#123;</div><div class="line">    <span class="string">"./submodule"</span>: <span class="string">"./src/submodule.js"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">import</span> submodule <span class="keyword">from</span> <span class="string">'es-module-package/submodule'</span>;</div><div class="line"></div><div class="line"><span class="comment">// 模块的主入口</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"exports"</span>: &#123;</div><div class="line">    <span class="string">"."</span>: <span class="string">"./main.js"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 等同于</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"exports"</span>: <span class="string">"./main.js"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 条件加载</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"type"</span>: <span class="string">"module"</span>,</div><div class="line">  <span class="string">"exports"</span>: &#123;</div><div class="line">    <span class="string">"."</span>: &#123;</div><div class="line">      <span class="string">"require"</span>: <span class="string">"./main.cjs"</span>,</div><div class="line">      <span class="string">"default"</span>: <span class="string">"./main.js"</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 等同于，如果同时还有其他别名，就不能采用简写</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"exports"</span>: &#123;</div><div class="line">    <span class="string">"require"</span>: <span class="string">"./main.cjs"</span>,</div><div class="line">    <span class="string">"default"</span>: <span class="string">"./main.js"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>CommonJS 的一个模块，就是一个脚本文件。<code>require</code> 命令第一次加载该脚本，就会执行整个脚本，然后在内存生成一个对象，以后需要用到这个模块的时候，就会到这个对象上面取值，即使再次执行 <code>require</code> 命令，也不会再次执行该模块，而是到缓存之中取值。也就是说，CommonJS 模块无论加载多少次，都只会在第一次加载时运行一次，以后再加载，就返回第一次运行的结果，除非手动清除系统缓存。CommonJS 模块的重要特性是加载时执行，即脚本代码在 <code>require</code> 的时候，就会全部执行。一旦出现某个模块被”循环加载”，就只输出已经执行的部分，还未执行的部分不会输出。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// a.js</span></div><div class="line">exports.done = <span class="literal">false</span>;</div><div class="line"><span class="keyword">var</span> b = <span class="built_in">require</span>(<span class="string">'./b.js'</span>);</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'在 a.js 之中，b.done = %j'</span>, b.done);</div><div class="line">exports.done = <span class="literal">true</span>;</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'a.js 执行完毕'</span>);</div><div class="line"></div><div class="line"><span class="comment">// b.js</span></div><div class="line">exports.done = <span class="literal">false</span>;</div><div class="line"><span class="keyword">var</span> a = <span class="built_in">require</span>(<span class="string">'./a.js'</span>);</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'在 b.js 之中，a.done = %j'</span>, a.done);</div><div class="line">exports.done = <span class="literal">true</span>;</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'b.js 执行完毕'</span>);</div><div class="line"></div><div class="line"><span class="comment">// main.js</span></div><div class="line"><span class="keyword">var</span> a = <span class="built_in">require</span>(<span class="string">'./a.js'</span>);</div><div class="line"><span class="keyword">var</span> b = <span class="built_in">require</span>(<span class="string">'./b.js'</span>);</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'在 main.js 之中, a.done=%j, b.done=%j'</span>, a.done, b.done);</div><div class="line"></div><div class="line"><span class="comment">// 在 b.js 之中，a.done = false</span></div><div class="line"><span class="comment">// b.js 执行完毕</span></div><div class="line"><span class="comment">// 在 a.js 之中，b.done = true</span></div><div class="line"><span class="comment">// a.js 执行完毕</span></div><div class="line"><span class="comment">// 在 main.js 之中, a.done=true, b.done=true</span></div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// a.mjs</span></div><div class="line"><span class="keyword">import</span> &#123;bar&#125; <span class="keyword">from</span> <span class="string">'./b'</span>;</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'a.mjs'</span>);</div><div class="line"><span class="built_in">console</span>.log(bar);</div><div class="line"><span class="keyword">export</span> <span class="keyword">let</span> foo = <span class="string">'foo'</span>;</div><div class="line"></div><div class="line"><span class="comment">// b.mjs</span></div><div class="line"><span class="keyword">import</span> &#123;foo&#125; <span class="keyword">from</span> <span class="string">'./a'</span>;</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'b.mjs'</span>);</div><div class="line"><span class="built_in">console</span>.log(foo);</div><div class="line"><span class="keyword">export</span> <span class="keyword">let</span> bar = <span class="string">'bar'</span>;</div><div class="line"></div><div class="line"><span class="comment">// $ node --experimental-modules a.mjs</span></div><div class="line"><span class="comment">// b.mjs</span></div><div class="line"><span class="comment">// ReferenceError: foo is not defined</span></div></pre></td></tr></table></figure>
<p>ES6 处理循环加载时，首先，执行 <code>a.mjs</code> 以后，引擎发现它加载了 <code>b.mjs</code>，因此会优先执行 <code>b.mjs</code>，然后再执行 <code>a.mjs</code>。接着，执行 <code>b.mjs</code> 的时候，已知它从 <code>a.mjs</code> 输入了 <code>foo</code> 接口，这时不会去执行 <code>a.mjs</code>，而是认为这个接口已经存在了，继续往下执行。执行到第三行 <code>console.log(foo)</code> 的时候，才发现这个接口根本没定义，因此报错。解决这个问题的方法，就是让 <code>b.mjs</code> 运行的时候，<code>foo</code> 已经有定义了，这可以通过将 <code>foo</code> 写成函数来解决，因为函数具有提升作用。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
       
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">小朱</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery.lazyload/1.9.3/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  



  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;

            $('.popup').detach().appendTo('.container');
            //$('.popup').detach().appendTo('.header-inner');

            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';                
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });
                            
                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').mousedown(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>

  

  

  

</body>
</html>
